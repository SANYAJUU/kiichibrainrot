<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ãƒ–ãƒ¬ã‚¤ãƒ³ãƒ­ãƒƒãƒˆï¼ˆ2ï¼‰</title>

    <style>
/* æ—¢å­˜ walker ç”¨ */
.walker{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:120px;
  padding:8px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  animation: float 1s ease-in-out infinite alternate;
}

/* æµ®éŠã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes float {
  0% { transform: translateX(-50%) translateY(0px); }
  50% { transform: translateX(-50%) translateY(3px); }
  100% { transform: translateX(-50%) translateY(0px); }
}

/* åŒæ™‚å¤‰ç•°ç”¨ ç‚¹æ»…å…‰ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes glowBlink {
  0%, 100% { box-shadow: 0 0 10px magenta, 0 0 20px orange, 0 0 30px aqua; }
  50% { box-shadow: 0 0 20px magenta, 0 0 40px orange, 0 0 60px aqua; }
}
.glow {
  animation: float 1s ease-in-out infinite alternate,
             glowBlink 0.8s ease-in-out infinite alternate;
}
</style>

<style>
body{
  margin:0;
  background:#111;
  color:white;
  font-family:sans-serif;
  overflow:hidden;
}

#ui{
  position:absolute;
  top:10px;
  left:10px;
  z-index:10;
}

#carpet{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:200px;
  height:2000px;
  background:linear-gradient(#700,#900);
}

#base{
  position:absolute;
  left:0;
  bottom:0;
  width:calc(50% - 100px);
  height:400px;
  border-top:3px solid cyan;
  border-right:3px solid cyan;
  padding:10px;
  box-sizing:border-box;
  overflow-y:auto;
  display:grid;
  grid-template-columns:repeat(auto-fill, 110px);
  gap:5px;
  background:#0a0f1a;
}

#fuseArea{
  position:absolute;
  right:40px;
  top:120px;
  width:260px;
  height:350px;
  border:4px solid white;
  background:#222;
  display:flex;
  flex-direction:column;
  padding:10px;
}

#fuseSlots{
  flex:1;
  overflow-y:auto;
}

/* ===== ã‚­ãƒ£ãƒ©å…±é€šã‚µã‚¤ã‚º ===== */
.char, .walker{
  width:100px;
  height:80px;
  padding:6px;
  font-size:12px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  box-sizing:border-box;
}
.walker{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  animation: float 1s ease-in-out infinite alternate;
}

@keyframes float {
  0% { transform: translateX(-50%) translateY(0px); }
  50% { transform: translateX(-50%) translateY(3px); }
  100% { transform: translateX(-50%) translateY(0px); }
}

button{cursor:pointer;margin-top:5px;}
@keyframes pulse{
  from { transform:scale(1); box-shadow:0 0 10px gold; }
  to   { transform:scale(1.08); box-shadow:0 0 25px orange; }
}

.char div,
.walker div{
  line-height:1.1;
}
.rarityBadge{
  position:absolute;
  top:4px;
  right:6px;
  pointer-events:none;
}

.rarityText{
  padding:2px 6px;
  border-radius:6px;
  font-size:10px;
  font-weight:bold;
  display:inline-block;
}

.char{
  position:relative;
}

#rightMenu{
  position:fixed;
  right:20px;
  top:120px;
  width:220px;
  display:flex;
  flex-direction:column;
  gap:10px;
  z-index:2000;
}

#rightMenu button{
  padding:10px;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
}

.sidePanel{
  display:none;
  background:#1e1e1e;
  padding:10px;
  border-radius:12px;
  max-height:400px;
  overflow-y:auto;
  color:white;
}
/* ===== å³ä¸Šãƒ»å³ä¸‹ãƒœã‚¿ãƒ³ ===== */

#tradeBtn{
  position:fixed;
  top:20px;
  right:20px;
  padding:12px 18px;
  background:#4CAF50;
  color:white;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
  z-index:2000;
}

#fuseBtn{
  position:fixed;
  bottom:20px;
  right:20px;
  padding:12px 18px;
  background:#2196F3;
  color:white;
  border:none;
  border-radius:10px;
  font-weight:bold;
  cursor:pointer;
  z-index:2000;
}
</style>
</head>
<body>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCs4uhyRzBC8nSJrwWrd_fBdzIJjR7D3A0",
  authDomain: "brainrot-3e022.firebaseapp.com",
  databaseURL: "https://brainrot-3e022-default-rtdb.firebaseio.com",
  projectId: "brainrot-3e022",
  storageBucket: "brainrot-3e022.firebasestorage.app",
  messagingSenderId: "489333416512",
  appId: "1:489333416512:web:1652e3f5cb8d3801ee75a5",
  measurementId: "G-HCFMTTL0WV"
};
</script>
<script>
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<div id="ui">
<h3>äº¤æ›æ²ç¤ºæ¿</h3>

<div id="createTradeBox"></div>
<hr>
<div id="publicTrades"></div>

</div>
<div id="codeBox" style="margin:10px;">
  <input id="codeInput" placeholder="ã‚³ãƒ¼ãƒ‰å…¥åŠ›">
  <button onclick="useCode()">ä½¿ç”¨</button>
</div>
ã‚­ãƒ£ãƒƒã‚·ãƒ¥ <span id="money">0</span><br>
ãƒªãƒãƒ¼ã‚¹ <span id="level">1</span><br>
å®¹é‡ <span id="cap">10</span><br>
ã‚­ãƒ£ãƒƒã‚·ãƒ¥å€ç‡ x<span id="multiplier">1</span><br>
<button id="upgradeBtn" onclick="upgradeBase()">ãƒªãƒãƒ¼ã‚¹ï¼ˆãŠé‡‘ãƒªã‚»ãƒƒãƒˆï¼‰</button>
<button onclick="resetGame()" style="background:red;color:white;">ãƒªã‚»ãƒƒãƒˆ</button>

<div id="adminPanel" style="
display:none;
position:absolute;
right:5px;
top:120px;
width:260px;
background:#111;
border:3px solid gold;
padding:15px;
z-index:1000;
cursor:move;
">
<h3 style="color:gold;">ğŸ‘‘ ç®¡ç†è€…ãƒ‘ãƒãƒ«</h3>

<button onclick="startAdminEvent()">ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹</button>
<button onclick="stopAdminEvent()">ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†</button>

<div id="eventStatus" style="margin-top:10px;color:lime;">
ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­
</div>

</div>
</div>

<div id="carpet"></div>

<div id="fuseArea">
<h3>ãƒã‚·ãƒ¼ãƒ³</h3>
    <div>åˆè¨ˆåç›Š: <span id="fuseTotal">0</span>/s</div>
<div id="fuseSlots"></div>
<button onclick="fuse()">åˆæˆ</button>
</div>

<div id="base"></div>

<script>
let playerId = localStorage.getItem("playerId");

if(!playerId){
  playerId = "player_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("playerId", playerId);
}
let adminEventActive = false;
let globalLuckMultiplier = 1;

let isAdmin = false;
let usedCodes = JSON.parse(localStorage.getItem("usedCodes")||"[]");
    
const rarities = [
 {name:"COMMON", color:"#777", rate:1000, chance:49},
 {name:"RARE", color:"blue", rate:5000, chance:26},
 {name:"EPIC", color:"purple", rate:20000, chance:14},
 {name:"LEGENDARY", color:"gold", rate:80000, chance:7},
 {name:"MYTHIC", color:"orange", rate:200000, chance:3},
 {name:"GOD", color:"rainbow", rate:1000000, chance:0.8},
 {name:"SECRET", color:"black", rate:0, chance:0.2}
];

const attributes = [
  {name:"Default", multiplier:1, chance:85, color:"#444"},

  {name:"Gold", multiplier:1.5, chance:5, color:"gold"},
  {name:"Diamond", multiplier:3, chance:3, color:"cyan"},
  {name:"Galaxy", multiplier:5, chance:2, color:"magenta"},
  {name:"Dreamy", multiplier:7, chance:1.5, color:"pink"},
  {name:"Lava", multiplier:8, chance:1, color:"red"},
  {name:"Aqua", multiplier:9, chance:0.8, color:"blue"},
  {name:"Rainbow", multiplier:10, chance:0.5, color:"orange"},
  {name:"Netherite", multiplier:10, chance:0.4, color:"gray"},
  {name:"Amethyst", multiplier:10.5, chance:0.3, color:"purple"},
  {name:"Toxic", multiplier:11, chance:0.3, color:"lime"},
  {name:"Ultimate", multiplier:12, chance:0.2, color:"white"}
];

const mutations = [
  {name:"Lightning", bonus:2, icon:"âš¡"},
  {name:"Ice", bonus:2, icon:"ğŸ§Š"},
  {name:"Nether", bonus:2.5, icon:"ğŸ”¥"},
  {name:"End", bonus:3, icon:"ğŸŒŒ"},
  {name:"Enchant", bonus:3, icon:"âœ¨"},
  {name:"Inmu", bonus:4, icon:"â˜ "}
];

const secretCharacters = [
 {character:"Piccione Macchina", rate:500000},
 {character:"Pakrahmatmamat", rate:600000},
 {character:"Orcalero Orcala", rate:1000000},
 {character:"Pot Hotspot", rate:2000000},
 {character:"Nooo My Hotspot", rate:2500000},
 {character:"Garamaramadungdung", rate:3000000},
 {character:"Il Sacro Cabrospaghetti", rate:4000000},
 {character:"La Grande Combinacion", rate:5000000},
 {character:"Yess My Hotspot", rate:5500000},
 {character:"67", rate:6700000},
 {character:"69", rate:13800000},
 {character:"Ketupat Kepat Prekupat", rate:10000000},
 {character:"Nooo My Bicicleteira", rate:13500000},
 {character:"W or L", rate:13000000},
 {character:"Lirili Ralilu", rate:17000000},
 {character:"La Esok Sekolah", rate:20000000},
 {character:"Chimpanzini Kingini", rate:25000000},
 {character:"Strawberry Elephant", rate:30000000},
 {character:"Klombo", rate:32000000},
 {character:"Gorgonzilla", rate:57000000},
 {character:"Spaghetti Tualetti", rate:40000000},
 {character:"Cannelloni Dragoni", rate:50000000},
 {character:"La Crazy Combinacion", rate:60000000},
 {character:"Chocone Dragone", rate:80000000},
 {character:"Gigalitraktos Spidorobos", rate:75000000},
 {character:"Tiramisubmarini", rate:90000000},
 {character:"Garbagzilla", rate:100000000},
 {character:"Cannone Maledettone", rate:115000000},
 {character:"SKIBIDI TOILET", rate:350000000},
 {character:"YAJUU SENPAI", rate:810000000}
];

const fuseTable = [
  { min:0, max:10000, results:[
    {type:"rarity", value:"COMMON", chance:25},
    {type:"rarity", value:"RARE", chance:35},
    {type:"rarity", value:"EPIC", chance:40}
  ]},
  { min:10000, max:50000, results:[
    {type:"rarity", value:"COMMON", chance:20},
    {type:"rarity", value:"RARE", chance:25},
    {type:"rarity", value:"EPIC", chance:55}
  ]},
  { min:50000, max:350000, results:[
    {type:"rarity", value:"RARE", chance:35},
    {type:"rarity", value:"EPIC", chance:50},
    {type:"rarity", value:"LEGENDARY", chance:25}
  ]},
  { min:350000, max:1000000, results:[
    {type:"rarity", value:"EPIC", chance:25},
    {type:"rarity", value:"LEGENDARY", chance:40},
    {type:"rarity", value:"MYTHIC", chance:25},
    {type:"rarity", value:"GOD", chance:10}
  ]},
  { min:1000000, max:2000000, results:[
    {type:"rarity", value:"MYTHIC", chance:35},
    {type:"rarity", value:"GOD", chance:55},
    {type:"secret", value:"Pot Hotspot", chance:10}
  ]},
  { min:2000000, max:5000000, results:[
    {type:"rarity", value:"GOD", chance:25},
    {type:"secret", value:"Pot Hotspot", chance:35},
    {type:"secret", value:"Garamaramadungdung", chance:25},
    {type:"secret", value:"La Grande Combinacion", chance:15}
  ]},
  { min:5000000, max:10000000, results:[
    {type:"secret", value:"Pot Hotspot", chance:25},
    {type:"secret", value:"67", chance:35},
    {type:"secret", value:"69", chance:30},
    {type:"secret", value:"Lirili Ralilu", chance:10}
  ]},
  { min:10000000, max:15000000, results:[
    {type:"secret", value:"67", chance:30},
    {type:"secret", value:"69", chance:25},
    {type:"secret", value:"Lirili Ralilu", chance:30},
    {type:"secret", value:"La Esok Sekolah", chance:15}
  ]},
  { min:15000000, max:25000000, results:[
    {type:"secret", value:"Lirili Ralilu", chance:35},
    {type:"secret", value:"La Esok Sekolah", chance:45},
    {type:"secret", value:"Chimpanzini Kingini", chance:15},
    {type:"secret", value:"Gorgonzilla", chance:5}
  ]},
  { min:25000000, max:35000000, results:[
    {type:"secret", value:"La Esok Sekolah", chance:35},
    {type:"secret", value:"Chimpanzini Kingini", chance:40},
    {type:"secret", value:"Spaghetti Tualetti", chance:18},
    {type:"secret", value:"Gorgonzilla", chance:10},
    {type:"secret", value:"La Crazy Combinacion", chance:2}
  ]},
  { min:35000000, max:45000000, results:[
    {type:"secret", value:"Chimpanzini Kingini", chance:45},
    {type:"secret", value:"Spaghetti Tualetti", chance:35},
    {type:"secret", value:"Gorgonzilla", chance:15},
    {type:"secret", value:"La Crazy Combinacion", chance:5}
  ]},
  { min:45000000, max:65000000, results:[
    {type:"secret", value:"Spaghetti Tualetti", chance:45},
    {type:"secret", value:"Gorgonzilla", chance:25},
    {type:"secret", value:"La Crazy Combinacion", chance:25},
    {type:"secret", value:"Gigalitraktos Spidorobos", chance:5}
  ]},
  { min:65000000, max:100000000, results:[
    {type:"secret", value:"Spaghetti Tualetti", chance:35},
    {type:"secret", value:"Gorgonzilla", chance:25},
    {type:"secret", value:"La Crazy Combinacion", chance:20},
    {type:"secret", value:"Gigalitraktos Spidorobos", chance:19},
    {type:"secret", value:"YAJUU SENPAI", chance:1}
  ]},
  { min:100000000, max:300000000, results:[
    {type:"secret", value:"Gorgonzilla", chance:45},
    {type:"secret", value:"La Crazy Combinacion", chance:35},
    {type:"secret", value:"Gigalitraktos Spidorobos", chance:15},
    {type:"secret", value:"YAJUU SENPAI", chance:5}
  ]},
  { min:300000000, max:500000000, results:[
    {type:"secret", value:"Gorgonzilla", chance:25},
    {type:"secret", value:"La Crazy Combinacion", chance:40},
    {type:"secret", value:"Gigalitraktos Spidorobos", chance:25},
    {type:"secret", value:"YAJUU SENPAI", chance:10}
  ]},
  { min:500000000, max:Infinity, results:[
    {type:"secret", value:"La Crazy Combinacion", chance:45},
    {type:"secret", value:"Gigalitraktos Spidorobos", chance:35},
    {type:"secret", value:"YAJUU SENPAI", chance:20}
  ]}
];

let money=0;
let baseLevel=1;
let capacity=10;
let incomeMultiplier=1;
let base=[];
let fuseList=[];
let spawnInterval;
let dragFromIndex=null;

/* ===== å¤‰ç•°å€ç‡ ===== */
const mutationMultiplierElectric = 3;
const mutationMultiplierIce = 2;

/* ===== æ•°å­—çœç•¥ ===== */
function format(num){
 if(num>=1e42) return (num/1e42).toFixed(1)+"TD";
 if(num>=1e39) return (num/1e39).toFixed(1)+"DD";
 if(num>=1e36) return (num/1e36).toFixed(1)+"UD";
 if(num>=1e33) return (num/1e33).toFixed(1)+"DC";
 if(num>=1e30) return (num/1e30).toFixed(1)+"NO";
 if(num>=1e27) return (num/1e27).toFixed(1)+"OC";
 if(num>=1e24) return (num/1e24).toFixed(1)+"SP";
 if(num>=1e21) return (num/1e21).toFixed(1)+"SX";
 if(num>=1e18) return (num/1e18).toFixed(1)+"QI";
 if(num>=1e15) return (num/1e15).toFixed(1)+"QA";
 if(num>=1e12) return (num/1e12).toFixed(1)+"T";
 if(num>=1e9) return (num/1e9).toFixed(1)+"B";
 if(num>=1e6) return (num/1e6).toFixed(1)+"M";
 if(num>=1e3) return (num/1e3).toFixed(1)+"K";
 return Math.floor(num);
}

/* ===== ã‚¹ãƒ­ãƒƒãƒˆä¿è¨¼ ===== */
function ensureBaseSlots(){
 while(base.length < capacity){
   base.push(null);
 }
 if(base.length > capacity){
   base = base.slice(0, capacity);
 }
}
function openTrade(){
  document.getElementById("tradePanel").style.display = "block";
}

function closeTrade(){
  document.getElementById("tradePanel").style.display = "none";
}

/* ===== UIæ›´æ–° ===== */
function updateUI(){
 const cost = Math.floor(50000*Math.pow(4, baseLevel-1));
 document.getElementById("money").innerText = format(money);
 document.getElementById("level").innerText = baseLevel;
 document.getElementById("cap").innerText = capacity;
 document.getElementById("multiplier").innerText = incomeMultiplier.toFixed(1);
 document.getElementById("upgradeBtn").innerText = "ãƒªãƒãƒ¼ã‚¹ï¼ˆãŠé‡‘ãƒªã‚»ãƒƒãƒˆï¼‰ (" + format(cost) + ")";
}

function toggleTrade(){
  const t = document.getElementById("tradePanel");
  const f = document.getElementById("fusePanel");
  f.style.display = "none";
  t.style.display = t.style.display==="block"?"none":"block";
}

function toggleFuse(){
  const t = document.getElementById("tradePanel");
  const f = document.getElementById("fusePanel");
  t.style.display = "none";
  f.style.display = f.style.display==="block"?"none":"block";
}

/* ===== ãƒªã‚»ãƒƒãƒˆ ===== */
function resetGame(){
 if(!confirm("æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿãƒ‡ãƒ¼ã‚¿ã¯æ¶ˆãˆã¾ã™ã€‚")) return;
 localStorage.removeItem("mergeSave");
 money=0; baseLevel=1; capacity=10; incomeMultiplier=1; base=[]; fuseList=[];
 ensureBaseSlots(); renderBase(); renderFuse(); updateUI();
}



/* ===== æŠ½é¸ ===== */
function getRandomRarity(){

  const adjusted = rarities.map(r=>{
    return {
      ...r,
      chance: r.chance * globalLuckMultiplier
    };
  });

  const total = adjusted.reduce((s,r)=>s+r.chance,0);
  const rand = Math.random()*total;

  let sum=0;

  for(let r of adjusted){
    sum+=r.chance;
    if(rand<=sum) return r;
  }
}

function spawnWalker(){

  let baseData = getRandomRarity();
  let data = {...baseData};

  if(baseData.name === "SECRET"){
    const pick = secretCharacters[Math.floor(Math.random()*secretCharacters.length)];
    data = { name:"SECRET", character: pick.character, rate: pick.rate, color:"black" };
  }

  // å±æ€§æŠ½é¸
  let totalChance = attributes.reduce((s,a)=>s+a.chance,0);
  let rand = Math.random()*totalChance;
  let sum = 0;
  for(let attr of attributes){
    sum += attr.chance;
    if(rand <= sum){
      data.attribute = attr;
      break;
    }
  }

  // å¤‰ç•°æŠ½é¸
  data.mutations = [];
  if(adminEventActive){
    mutations.forEach(m=>{ if(Math.random()<0.15) data.mutations.push(m); });
  }

  // æœ€çµ‚å€ç‡è¨ˆç®—
  let totalMultiplier = data.attribute.multiplier;
  data.mutations.forEach(m=>totalMultiplier += m.bonus);
  data.rate = Math.floor(data.rate * totalMultiplier);

  const div = document.createElement("div");
  div.className = "walker";
  div.style.background = data.attribute ? data.attribute.color : "#444";
  div.style.border = "2px solid white";

  let attributeName = data.attribute ? data.attribute.name : "Default";
  let rarityText = data.name === "SECRET" ? data.character : data.name;

  // ãƒ¬ã‚¢åº¦ãƒãƒƒã‚¸
  const raritySpan = document.createElement("span");
  raritySpan.innerText = rarityText;
  switch(data.name){
    case "COMMON": raritySpan.style.background="#6b3e1d"; raritySpan.style.color="white"; break;
    case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
    case "EPIC": raritySpan.style.background="purple"; raritySpan.style.color="#ffccff"; break;
    case "LEGENDARY": raritySpan.style.background="yellow"; raritySpan.style.color="#b36b00"; break;
    case "MYTHIC": raritySpan.style.background="gold"; raritySpan.style.color="#5a3b00"; break;
    case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
    case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
  }
  raritySpan.style.padding="2px 6px";
  raritySpan.style.borderRadius="6px";
  raritySpan.style.fontSize="10px";
  raritySpan.style.display="inline-block";
  raritySpan.style.marginTop="2px";

 let mutationIcons = "";
if(data.mutations && data.mutations.length > 0){
  mutationIcons = data.mutations.map(m=>m.icon).join("");
}
  div.innerHTML =
    "<div>[" + attributeName + "]</div>" +
    "<div>" + raritySpan.outerHTML + "</div>" +
    "<div>+" + format(data.rate) + "/s</div>";

  div.style.top = "-100px";
  document.body.appendChild(div);

  let pos=-100;
  const move = setInterval(()=>{
    pos += 1;
    div.style.top = pos + "px";
    if(pos>window.innerHeight){
      div.remove();
      clearInterval(move);
    }
  },30);

  div.onclick = ()=>{
    const emptyIndex = base.findIndex(s=>s===null);
    if(emptyIndex!==-1){
      base[emptyIndex]=data;
      renderBase();
      div.remove();
      clearInterval(move);
    }
  };

  data.baseRate = data.rate;
}


/* ===== åŸºåœ°æç”» ===== */
function renderBase(){
  const baseDiv = document.getElementById("base");
  baseDiv.innerHTML = "";

  base.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className = "char";

    if(c){
      div.draggable = true;
      div.style.background = c.attribute ? c.attribute.color : "#444";
      div.style.border = "1px solid #333";

      // å¤‰ç•°ã‚¢ã‚¤ã‚³ãƒ³
      let mutationIcons = "";
      if(c.mutations && c.mutations.length > 0){
        mutationIcons = c.mutations.map(m=>m.icon).join("");
      }

      let attributeName = c.attribute ? c.attribute.name : "Default";
      let rarityText = c.name === "SECRET" ? c.character : c.name;

      // ãƒ¬ã‚¢åº¦ãƒãƒƒã‚¸
      const raritySpan = document.createElement("span");
      raritySpan.innerText = rarityText;
      switch(c.name){
        case "COMMON": raritySpan.style.background="#6b3e1d"; raritySpan.style.color="white"; break;
        case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
        case "EPIC": raritySpan.style.background="purple"; raritySpan.style.color="#ffccff"; break;
        case "LEGENDARY": raritySpan.style.background="yellow"; raritySpan.style.color="#b36b00"; break;
        case "MYTHIC": raritySpan.style.background="gold"; raritySpan.style.color="#5a3b00"; break;
        case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
        case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
      }
      raritySpan.style.padding="2px 6px";
      raritySpan.style.borderRadius="6px";
      raritySpan.style.fontSize="10px";
      raritySpan.style.display="inline-block";
      raritySpan.style.marginTop="2px";

      // HTMLæ§‹æˆ: å±æ€§ â†’ ãƒ¬ã‚¢åº¦ â†’ å¤‰ç•° â†’ ç¨¼ãé‡‘é¡
      div.innerHTML =
        "<div>[" + attributeName + "]</div>" +
        "<div>" + raritySpan.outerHTML + "</div>" +
        "<div>" + mutationIcons + " +" + format(c.rate) + "/s</div>";

      div.onclick = ()=>{
        if(fuseList.length >= 5) return;
        fuseList.push(c);
        base[i] = null;
        renderBase();
        renderFuse();
      };

      div.oncontextmenu = (e)=>{
        e.preventDefault();
        base[i] = null;
        renderBase();
      };

    } else {
      div.style.background = "#111";
      div.style.border = "1px dashed #333";
    }

    baseDiv.appendChild(div);
  });
}
function playSecretSound(text){
   const msg = new SpeechSynthesisUtterance(text);
   msg.lang = "en-US"; // è‹±èªèª­ã¿
   msg.pitch = 1.2;
   msg.rate = 0.9;
   speechSynthesis.speak(msg);
}

function startAdminEvent(){
  if(!isAdmin) return;

  db.ref("globalEvent").set({
    active: true,
    luck: 67,
    startTime: Date.now()
  });
}

function stopAdminEvent(){
  if(!isAdmin) return;

  db.ref("globalEvent").set({
    active:false
  });
}

function useCode(){
  const input = document.getElementById("codeInput");
  const code = input.value.trim();
  input.value = "";

  if(!code) return;

  // ç®¡ç†è€…ã¯åˆ¶é™ãªã—
  if(!isAdmin && usedCodes.includes(code)){
    alert("ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨æ¸ˆã¿ã§ã™ï¼");
    return;
  }

  // ===== ç®¡ç†è€…ã‚³ãƒ¼ãƒ‰ =====
  if(code === "670402"){
  isAdmin = true;
  document.getElementById("adminPanel").style.display = "block";
  alert("ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰èµ·å‹•");
  return;
}

  

  if(!isAdmin){
    usedCodes.push(code);
    localStorage.setItem("usedCodes",JSON.stringify(usedCodes));
  }
}
function createTrade(targetId, myCharIndex){

  const tradeRef = db.ref("trades").push();

  tradeRef.set({
    from: playerId,
    to: targetId,
    fromCharIndex: myCharIndex,
    toCharIndex: null,
    fromReady: false,
    toReady: false,
    status: "pending"
  });

  alert("äº¤æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼");
}
function readyTrade(tradeId){

  db.ref("trades/"+tradeId).once("value").then(snap=>{
    const trade = snap.val();
    if(!trade) return;

    if(trade.from === playerId){
      db.ref("trades/"+tradeId).update({fromReady:true});
    }else if(trade.to === playerId){
      db.ref("trades/"+tradeId).update({toReady:true});
    }
  });
}
db.ref("trades").on("child_added", snapshot=>{

  const tradeId = snapshot.key;

  db.ref("trades/"+tradeId).on("value", snap=>{

    const trade = snap.val();
    if(!trade) return;

    if(trade.status !== "pending") return;

    if(trade.fromReady && trade.toReady){
      completeTrade(tradeId, trade);
    }

  });

});

function completeTrade(tradeId, trade){

  db.ref().transaction(data=>{
    if(!data) return data;

    const fromBase = data.players[trade.from]?.base;
    const toBase   = data.players[trade.to]?.base;

    if(!fromBase || !toBase) return;

    const fromChar = fromBase[trade.fromCharIndex];
    const toChar   = toBase[trade.toCharIndex];

    if(!fromChar || !toChar) return;

    fromBase[trade.fromCharIndex] = toChar;
    toBase[trade.toCharIndex] = fromChar;

    data.trades[tradeId].status = "completed";

    return data;
  });

}

let selectedTradeCharIndex = null;

function renderTradeChars(){

  const container = document.getElementById("myTradeChars");
  container.innerHTML = "";

  base.forEach((char,index)=>{
    const div = document.createElement("div");
    div.textContent = char.name + " (Lv"+char.level+")";
    div.style.cursor = "pointer";
    div.style.padding = "4px";
    div.style.border = "1px solid #555";
    div.style.marginBottom = "4px";

    div.onclick = ()=>{
      selectedTradeCharIndex = index;
      renderTradeChars();
    };

    if(index === selectedTradeCharIndex){
      div.style.background = "orange";
    }

    container.appendChild(div);
  });

}
function sendTradeRequest(){

  const targetId = document.getElementById("tradeTargetId").value;

  if(!targetId || selectedTradeCharIndex===null){
    alert("ç›¸æ‰‹IDã¨ã‚­ãƒ£ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„");
    return;
  }

  const tradeRef = db.ref("trades").push();

  tradeRef.set({
    from: playerId,
    to: targetId,
    fromCharIndex: selectedTradeCharIndex,
    toCharIndex: null,
    fromReady: false,
    toReady: false,
    status: "pending",
    timestamp: Date.now()
  });

  alert("äº¤æ›ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡ï¼");
}
db.ref("trades").on("child_added", snapshot=>{

  const tradeId = snapshot.key;

  db.ref("trades/"+tradeId).on("value", snap=>{

    const trade = snap.val();
    if(!trade) return;
    if(trade.status !== "pending") return;

    if(trade.to === playerId){
      showIncomingTrade(tradeId, trade);
    }

    if(trade.fromReady && trade.toReady){
      completeTrade(tradeId, trade);
    }

  });

});
function showIncomingTrade(tradeId, trade){

  const container = document.getElementById("incomingTrades");
  container.innerHTML = "";

  const div = document.createElement("div");
  div.style.border="1px solid red";
  div.style.padding="6px";
  div.style.marginBottom="6px";

  div.innerHTML = `
    <div>ğŸ“© ${trade.from} ã‹ã‚‰äº¤æ›ç”³è«‹</div>
    <div>ã‚ãªãŸã®ã‚­ãƒ£ãƒ©ã‚’é¸æŠ:</div>
  `;

  base.forEach((char,index)=>{
    const btn = document.createElement("button");
    btn.textContent = char.name;

    btn.onclick = ()=>{
      db.ref("trades/"+tradeId).update({
        toCharIndex:index
      });
    };

    div.appendChild(btn);
  });

  const readyBtn = document.createElement("button");
  readyBtn.textContent = "æ‰¿èª";
  readyBtn.onclick = ()=>{
    db.ref("trades/"+tradeId).update({toReady:true});
  };

  div.appendChild(document.createElement("br"));
  div.appendChild(readyBtn);

  container.appendChild(div);
}
function completeTrade(tradeId, trade){

  db.ref().transaction(data=>{
    if(!data) return data;

    const fromBase = data.players[trade.from]?.base;
    const toBase   = data.players[trade.to]?.base;

    if(!fromBase || !toBase) return;

    const fromChar = fromBase[trade.fromCharIndex];
    const toChar   = toBase[trade.toCharIndex];

    if(!fromChar || !toChar) return;

    fromBase[trade.fromCharIndex] = toChar;
    toBase[trade.toCharIndex] = fromChar;

    data.trades[tradeId].status = "completed";

    return data;
  });

}
let tradeOpen = false;

function toggleTradePanel(){
  const panel = document.getElementById("tradePanel");
  tradeOpen = !tradeOpen;
  panel.style.right = tradeOpen ? "0px" : "-400px";
}
function renderCreateTrade(){

  const box = document.getElementById("createTradeBox");
  box.innerHTML = "";

  const msgInput = document.createElement("input");
  msgInput.placeholder = "ä¾‹ï¼šã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ±‚ã‚€ï¼";
  msgInput.style.width="100%";

  let selectedIndex = null;

  base.forEach((char,index)=>{
    const div = document.createElement("div");
    div.textContent = char.name;
    div.style.cursor="pointer";
    div.style.border="1px solid #555";
    div.style.margin="4px 0";
    div.style.padding="4px";

    div.onclick = ()=>{
      selectedIndex = index;
      renderCreateTrade();
    };

    if(index===selectedIndex){
      div.style.background="orange";
    }

    box.appendChild(div);
  });

  const btn = document.createElement("button");
  btn.textContent="ğŸ“¢ å…¬é–‹ã™ã‚‹";
  btn.style.width="100%";

  btn.onclick = ()=>{
    if(selectedIndex===null){
      alert("ã‚­ãƒ£ãƒ©é¸ã‚“ã§");
      return;
    }

    db.ref("publicTrades").push({
      owner: playerId,
      charIndex: selectedIndex,
      message: msgInput.value,
      status:"open",
      timestamp:Date.now()
    });
  };

  box.prepend(msgInput);
  box.appendChild(btn);
}
db.ref("publicTrades").on("value",snap=>{
  const trades = snap.val();
  const container = document.getElementById("publicTrades");
  container.innerHTML="";

  if(!trades) return;

  Object.entries(trades).forEach(([id,trade])=>{

    if(trade.status!=="open") return;

    const div = document.createElement("div");
    div.style.border="1px solid #888";
    div.style.margin="6px 0";
    div.style.padding="6px";

    div.innerHTML = `
      <div><b>${trade.owner}</b></div>
      <div>ğŸ’¬ ${trade.message||"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>
      <button onclick="applyTrade('${id}')">ã“ã®äººã¨äº¤æ›</button>
    `;

    container.appendChild(div);
  });

});
function applyTrade(tradeId){

  const myIndex = prompt("è‡ªåˆ†ã®ã©ã®ã‚­ãƒ£ãƒ©ç•ªå·ã‚’å‡ºã™ï¼Ÿï¼ˆindexï¼‰");

  if(myIndex===null) return;

  db.ref("publicTrades/"+tradeId).update({
    applicant: playerId,
    applicantCharIndex: Number(myIndex),
    status:"pending"
  });

}
db.ref("publicTrades").on("child_changed",snap=>{

  const trade = snap.val();
  const tradeId = snap.key;

  if(trade.status==="pending" && trade.owner===playerId){

    if(confirm("äº¤æ›ç”³è«‹ãŒæ¥ã¾ã—ãŸï¼æ‰¿èªã™ã‚‹ï¼Ÿ")){
      completePublicTrade(tradeId,trade);
    }
  }

});
function completePublicTrade(tradeId, trade){

  db.ref().transaction(data=>{
    if(!data) return data;

    const ownerBase = data.players[trade.owner]?.base;
    const applicantBase = data.players[trade.applicant]?.base;

    if(!ownerBase || !applicantBase) return;

    const ownerChar = ownerBase[trade.charIndex];
    const applicantChar = applicantBase[trade.applicantCharIndex];

    if(!ownerChar || !applicantChar) return;

    ownerBase[trade.charIndex] = applicantChar;
    applicantBase[trade.applicantCharIndex] = ownerChar;

    data.publicTrades[tradeId].status="completed";

    return data;
  });

}

function postToBoard(){

  const message = document.getElementById("boardMessage").value;

  if(selectedTradeCharIndex === null){
    alert("ã‚­ãƒ£ãƒ©é¸ã‚“ã§");
    return;
  }

  db.ref("publicBoard").push({
    owner: playerId,
    ownerCharIndex: selectedTradeCharIndex,
    message: message,
    status: "open",
    timestamp: Date.now()
  });

  alert("æ²ç¤ºæ¿ã«æŠ•ç¨¿ã—ã¾ã—ãŸï¼");
}

db.ref("publicBoard").on("value",snap=>{

  const data = snap.val();
  const container = document.getElementById("publicTrades");
  container.innerHTML="";

  if(!data) return;

  Object.entries(data).forEach(([id,trade])=>{

    if(trade.status !== "open") return;

    const ownerChar = playersCache[trade.owner]?.base?.[trade.ownerCharIndex];
    if(!ownerChar) return;

    const div = document.createElement("div");
    div.style.border="1px solid #666";
    div.style.padding="6px";
    div.style.margin="6px 0";

    div.innerHTML = `
      <div><b>${trade.owner}</b></div>
      <div>ğŸ’¬ ${trade.message||"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>
      <div>ğŸ“¦ æä¾›ï¼š${ownerChar.name}</div>
      <button onclick="applyToBoard('${id}')">äº¤æ›ç”³è«‹</button>
    `;

    container.appendChild(div);
  });

});

function applyToBoard(tradeId){

  const myIndex = prompt("è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã®ç•ªå·ã‚’å…¥åŠ›");

  if(myIndex===null) return;

  db.ref("publicBoard/"+tradeId).update({
    applicant: playerId,
    applicantCharIndex: Number(myIndex),
    status:"pending"
  });

  alert("ç”³è«‹ã—ã¾ã—ãŸï¼");
}

db.ref("publicBoard").on("child_changed",snap=>{

  const trade = snap.val();
  const tradeId = snap.key;

  if(trade.status==="pending" && trade.owner===playerId){

    const accept = confirm("äº¤æ›ç”³è«‹ãŒæ¥ã¾ã—ãŸï¼æ‰¿èªã—ã¾ã™ã‹ï¼Ÿ");

    if(accept){
      completeBoardTrade(tradeId, trade);
    }else{
      db.ref("publicBoard/"+tradeId).update({
        status:"open",
        applicant:null,
        applicantCharIndex:null
      });
    }

  }

});

function completeBoardTrade(tradeId, trade){

  db.ref().transaction(data=>{
    if(!data) return data;

    const ownerBase = data.players[trade.owner]?.base;
    const applicantBase = data.players[trade.applicant]?.base;

    if(!ownerBase || !applicantBase) return;

    const ownerChar = ownerBase[trade.ownerCharIndex];
    const applicantChar = applicantBase[trade.applicantCharIndex];

    if(!ownerChar || !applicantChar) return;

    ownerBase[trade.ownerCharIndex] = applicantChar;
    applicantBase[trade.applicantCharIndex] = ownerChar;

    data.publicBoard[tradeId].status="done";

    return data;
  });

}

/* ===== åˆæˆè¡¨ç¤º ===== */
function renderFuse(){
  const fuseDiv = document.getElementById("fuseSlots");
  fuseDiv.innerHTML = "";

  let total = 0;

  // æŠ•å…¥ã‚­ãƒ£ãƒ©ã®è¡¨ç¤º
  fuseList.forEach((c)=>{
    total += c.rate;
    const div = document.createElement("div");
    div.className = "char";
    div.style.background = c.attribute ? c.attribute.color : "#444";

    // å¤‰ç•°ã‚¢ã‚¤ã‚³ãƒ³
    let mutationIcons = "";
    if(c.mutations && c.mutations.length > 0){
      mutationIcons = c.mutations.map(m=>m.icon).join("");
    }

    let attributeName = c.attribute ? c.attribute.name : "Default";
    let rarityText = c.name === "SECRET" ? c.character : c.name;

    // ãƒ¬ã‚¢åº¦ãƒãƒƒã‚¸
    const raritySpan = document.createElement("span");
    raritySpan.innerText = rarityText;
    switch(c.name){
      case "COMMON": raritySpan.style.background="#6b3e1d"; raritySpan.style.color="white"; break;
      case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
      case "EPIC": raritySpan.style.background="purple"; raritySpan.style.color="#ffccff"; break;
      case "LEGENDARY": raritySpan.style.background="yellow"; raritySpan.style.color="#b36b00"; break;
      case "MYTHIC": raritySpan.style.background="gold"; raritySpan.style.color="#5a3b00"; break;
      case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
      case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
    }
    raritySpan.style.padding="2px 6px";
    raritySpan.style.borderRadius="6px";
    raritySpan.style.fontSize="10px";
    raritySpan.style.display="inline-block";
    raritySpan.style.marginTop="2px";

    // HTMLæ§‹æˆ: å±æ€§ â†’ ãƒ¬ã‚¢åº¦ â†’ å¤‰ç•° â†’ ç¨¼ãé‡‘é¡
    div.innerHTML =
      "<div>[" + attributeName + "]</div>" +
      "<div>" + raritySpan.outerHTML + "</div>" +
      "<div>" + mutationIcons + " +" + format(c.rate) + "/s</div>";

    // ã‚¯ãƒªãƒƒã‚¯ã§åŸºåœ°ã«æˆ»ã™
    div.onclick = ()=>{
      const emptyIndex = base.findIndex(s=>s===null);
      if(emptyIndex === -1) return;
      const index = fuseList.indexOf(c);
      if(index !== -1) fuseList.splice(index,1);
      base[emptyIndex] = c;
      renderBase();
      renderFuse();
    };

    fuseDiv.appendChild(div);
  });

  document.getElementById("fuseTotal").innerText = format(total);

  // å±æ€§æŠ½é¸ãƒ»å¤‰ç•°æŠ½é¸è¡¨ç¤º
  if(fuseList.length > 0){
    const totalRate = fuseList.reduce((s,c)=>s+(c.rate||0),0);

    const attrMap = {};
    fuseList.forEach(c=>{
      const attrName = c.attribute ? c.attribute.name : "Default";
      if(!attrMap[attrName]) attrMap[attrName] = 0;
      attrMap[attrName] += c.rate||0;
    });

    const infoDiv = document.createElement("div");
    infoDiv.style.marginTop = "10px";
    infoDiv.innerHTML = "<hr>å±æ€§æŠ½é¸ç¢ºç‡ï¼ˆrateä¾å­˜ï¼‰<br>";

    for(const [name, weight] of Object.entries(attrMap)){
      const percent = Math.round(weight/totalRate*100);
      infoDiv.innerHTML += name + " : " + percent + "%<br>";
    }

    // å¤‰ç•°ç¢ºç‡è¡¨ç¤º
    infoDiv.innerHTML += "<br>å¤‰ç•°æŠ½é¸ç¢ºç‡<br>";
    mutations.forEach(m=>{
      let mutRate = fuseList.reduce((sum,c)=>sum + ((c.mutations||[]).some(mt=>mt.name===m.name)?c.rate||0:0),0);
      let chance = 5 + (mutRate/totalRate)*50;
      infoDiv.innerHTML += m.name + " : " + Math.round(chance) + "%<br>";
    });

    fuseDiv.appendChild(infoDiv);

    // â˜… åˆæˆçµæœã®å‡ºç¾ç¢ºç‡è¡¨ç¤ºï¼ˆä¿®æ­£ç‰ˆï¼šã‚­ãƒ£ãƒ©ã®æ•°ã«é–¢ä¿‚ãªã1å›ã ã‘ï¼‰
    const totalBaseRate = fuseList.reduce((sum,c)=>sum+(c.baseRate||c.rate),0);
    const table = fuseTable.find(t => totalBaseRate >= t.min && totalBaseRate < t.max);
    if(table){
      const chanceDiv = document.createElement("div");
      chanceDiv.style.marginTop = "10px";
      chanceDiv.innerHTML = "<hr><b>åˆæˆçµæœã®å‡ºç¾ç¢ºç‡</b><br>";

      const totalChance = table.results.reduce((s,r)=>s+r.chance,0);

      table.results.forEach(r=>{
        let name = r.type === "secret" ? r.value : r.value;
        let percent = Math.round(r.chance / totalChance * 100);
        chanceDiv.innerHTML += name + " : " + percent + "%<br>";
      });

      fuseDiv.appendChild(chanceDiv);
    }
  }
}

function fuse(){
  // æŠ•å…¥ã‚­ãƒ£ãƒ©ãŒ5ä½“æƒã£ã¦ã„ãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
  if(fuseList.length !== 5) return;

  // æŠ•å…¥ã‚­ãƒ£ãƒ©å…¨ã¦ã‚’ä½¿ç”¨
  const used = fuseList.splice(0,5);

  // â˜… baseRateãŒç„¡ã„å ´åˆã¯rateã‚’ä½¿ã†
  const totalBaseRate = used.reduce((sum,c)=>{
    return sum + (c.baseRate ? c.baseRate : c.rate);
  },0);

  const table = fuseTable.find(t => totalBaseRate >= t.min && totalBaseRate < t.max);
  if(!table){
    renderFuse(); // ä½•ã‚‚åˆæˆã•ã‚Œãªã„ã®ã§UIã ã‘æ›´æ–°
    return;
  }

  const totalChance = table.results.reduce((s,r)=>s+r.chance,0);
  const rand = Math.random() * totalChance;

  let sum = 0;
  let chosen = table.results[0];

  for(let r of table.results){
    sum += r.chance;
    if(rand <= sum){
      chosen = r;
      break;
    }
  }

  let newChar;

  if(chosen.type === "rarity"){
    const rarityData = rarities.find(r => r.name === chosen.value);
    newChar = {...rarityData};
    newChar.baseRate = rarityData.rate;
  }else{
    const secretData = secretCharacters.find(s => s.character === chosen.value);
    newChar = {
      name:"SECRET",
      character: secretData.character,
      color:"black",
      baseRate: secretData.rate
    };
  }

  // å±æ€§ãƒ»å¤‰ç•°å¼•ãç¶™ãï¼ˆæœ€åˆã®ã‚­ãƒ£ãƒ©ã‹ã‚‰ç°¡æ˜“ã‚³ãƒ”ãƒ¼ï¼‰
  const firstChar = used[0];
  newChar.attribute = firstChar.attribute;
  newChar.mutations = firstChar.mutations ? [...firstChar.mutations] : [];
  newChar.rate = Math.floor((newChar.baseRate || newChar.rate) * 
                            (newChar.attribute ? newChar.attribute.multiplier : 1) + 
                            newChar.mutations.reduce((s,m)=>s+m.bonus,0));

  // ç©ºãã‚¹ãƒ­ãƒƒãƒˆã«é…ç½®
  const emptyIndex = base.findIndex(s=>s===null);
  if(emptyIndex !== -1){
    base[emptyIndex] = newChar;
  } else {
    // ç©ºããŒç„¡ã‘ã‚Œã°fuseListã«æˆ»ã™
    fuseList.push(newChar);
  }

  renderBase();
  renderFuse();
}



/* ===== å¼·åŒ–ï¼ˆãƒªãƒãƒ¼ã‚¹ï¼‰ ===== */
function upgradeBase(){
 const cost=Math.floor(50000*Math.pow(4,baseLevel-1));
 if(money>=cost){
   money=0; // â˜…ãŠé‡‘ãƒªã‚»ãƒƒãƒˆ
   baseLevel++;
   capacity+=2;
   incomeMultiplier+=0.5;
   ensureBaseSlots();
   renderBase();
   updateUI();
 }
}

// ===== ç®¡ç†è€…ãƒ‘ãƒãƒ« ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ =====
const adminPanel = document.getElementById("adminPanel");

let isDragging = false;
let offsetX, offsetY;

adminPanel.addEventListener("mousedown", (e)=>{
  isDragging = true;

  offsetX = e.clientX - adminPanel.offsetLeft;
  offsetY = e.clientY - adminPanel.offsetTop;

  adminPanel.style.right = "auto"; // rightå›ºå®šè§£é™¤
});

document.addEventListener("mousemove", (e)=>{
  if(!isDragging) return;

  adminPanel.style.left = (e.clientX - offsetX) + "px";
  adminPanel.style.top  = (e.clientY - offsetY) + "px";
});

document.addEventListener("mouseup", ()=>{
  isDragging = false;
});

/* ===== åç›Š ===== */
setInterval(()=>{
 let income = base.filter(c=>c).reduce((sum,c)=>sum+c.rate,0);
 money += income * incomeMultiplier;
 updateUI();
},1000);

/* ===== ã‚»ãƒ¼ãƒ– ===== */
function saveGame(){
  db.ref("players/" + playerId).set({
    money,
    baseLevel,
    capacity,
    incomeMultiplier,
    base,
    fuseList,
    lastSave: Date.now()
  });
}
setInterval(saveGame,1000);

/* ===== ãƒ­ãƒ¼ãƒ‰ ===== */
function loadGame(){
  db.ref("players/" + playerId).once("value").then(snapshot=>{
    const data = snapshot.val();
    if(!data) return;

    money = data.money || 0;
    baseLevel = data.baseLevel || 1;
    capacity = data.capacity || 10;
    incomeMultiplier = data.incomeMultiplier || 1;
    base = data.base || [];
    fuseList = data.fuseList || [];

    ensureBaseSlots();
    renderBase();
    renderFuse();
    updateUI();
  });
}

function openTrade(){
  document.getElementById("tradeScreen").style.display = "block";
}

function closeTrade(){
  document.getElementById("tradeScreen").style.display = "none";
}

function openFuse(){
  document.getElementById("fuseScreen").style.display = "block";
}

function closeFuse(){
  document.getElementById("fuseScreen").style.display = "none";
}

/* ===== ã‚¿ãƒ–ç›£è¦– ===== */
function startSpawn(){ spawnInterval=setInterval(spawnWalker,3000); }
function stopSpawn(){ clearInterval(spawnInterval); }
document.addEventListener("visibilitychange",()=>{ document.hidden ? stopSpawn() : startSpawn(); });

/* ===== åˆæœŸåŒ– ===== */
loadGame();
ensureBaseSlots();
renderBase();
startSpawn();
updateUI();

db.ref("globalEvent").on("value", snapshot=>{
  const data = snapshot.val();
  if(data && data.active){
    adminEventActive = true;
    globalLuckMultiplier = data.luck;
    document.getElementById("adminEventBanner").style.display="block";
    document.getElementById("eventStatus").innerText="ğŸ”¥ ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ä¸­";
  }else{
    adminEventActive = false;
    globalLuckMultiplier = 1;
    document.getElementById("adminEventBanner").style.display="none";
    document.getElementById("eventStatus").innerText="ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­";
  }
});
</script>
<div id="adminEventBanner" style="
display:none;
position:fixed;
right:20px;
bottom:20px;
background:linear-gradient(45deg,gold,orange);
color:black;
font-weight:bold;
padding:12px 20px;
border-radius:10px;
box-shadow:0 0 15px gold;
z-index:2000;
animation:pulse 1s infinite alternate;
">
ğŸ‘‘ ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•ä¸­


</div>

<div id="tradePanel" style="
display:none;
position:fixed;
right:20px;
top:80px;
width:350px;
height:500px;
background:#1e1e1e;
color:white;
padding:15px;
border-radius:15px;
box-shadow:0 0 20px black;
overflow-y:auto;
z-index:2500;
">

<h3>äº¤æ›æ²ç¤ºæ¿</h3>

<div id="createTradeBox"></div>
<hr>
<div id="publicTrades"></div>

<button onclick="closeTrade()" style="width:100%;margin-top:10px;">é–‰ã˜ã‚‹</button>

</div>
<div id="rightMenu">

  <button onclick="toggleTrade()">ğŸ”„ ã‚­ãƒ£ãƒ©äº¤æ›</button>
  <button onclick="toggleFuse()">ğŸ§ª åˆæˆ</button>

  <div id="tradePanel" class="sidePanel"></div>
  <div id="fusePanel" class="sidePanel"></div>

</div>
</body>
</html>
