<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>kiichibrainrot</title>
<style>
/* æ—¢å­˜ walker ç”¨ */
.walker{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:120px;
  padding:8px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  animation: float 1s ease-in-out infinite alternate;
}

@keyframes float {
  0% { transform: translateX(-50%) translateY(0px); }
  50% { transform: translateX(-50%) translateY(3px); }
  100% { transform: translateX(-50%) translateY(0px); }
}

@keyframes glowBlink {
  0%, 100% { box-shadow: 0 0 10px magenta, 0 0 20px orange, 0 0 30px aqua; }
  50% { box-shadow: 0 0 20px magenta, 0 0 40px orange, 0 0 60px aqua; }
}

.glow {
  animation: float 1s ease-in-out infinite alternate, glowBlink 0.8s ease-in-out infinite alternate;
}

body{
  margin:0;
  background:#111;
  color:white;
  font-family:sans-serif;
  overflow:hidden;
}

#ui{
  position:absolute;
  top:10px;
  left:10px;
  z-index:10;
  max-width:300px;
  max-height:180px;
  overflow-y:auto;
}

#ui h3 {
  display:none;
}

#ui div {
  font-size:12px;
  margin:2px 0;
}

#carpet{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:200px;
  height:2000px;
  background:linear-gradient(#700,#900);
}

#base{
  position:absolute;
  left:0;
  bottom:0;
  width:calc(45% - 80px);
  height:300px;
  border-top:3px solid cyan;
  border-right:3px solid cyan;
  padding:10px;
  box-sizing:border-box;
  overflow-y:auto;
  display:grid;
  grid-template-columns:repeat(auto-fill, 110px);
  gap:5px;
  background:#0a0f1a;
}

.char, .walker{
  width:100px;
  height:80px;
  padding:6px;
  font-size:12px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  box-sizing:border-box;
}

.walker{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  animation: float 1s ease-in-out infinite alternate;
}

button{cursor:pointer;}

.char div, .walker div{
  line-height:1.1;
}

.char{
  position:relative;
}

#notificationPanel {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.95);
  color:white;
  padding:20px 30px;
  border-radius:15px;
  border:2px solid #4CAF50;
  box-shadow:0 0 30px rgba(76,175,80,0.5);
  z-index:5000;
  display:none;
  text-align:center;
  font-size:16px;
  font-weight:bold;
  max-width:400px;
}

#tradePanel{
  position:fixed;
  top:20px;
  right:20px;
  width:380px;
  max-height:650px;
  background:#1e1e1e;
  color:white;
  padding:15px;
  border-radius:15px;
  box-shadow:0 0 25px black;
  overflow-y:auto;
  z-index:3000;
  display:none;
  border:2px solid #4CAF50;
}

#tradePanel h3{
  margin-top:0;
  color:#4CAF50;
}

#tradePanel input{
  position:fixed;
  width:100%;
  padding:8px;
  margin:5px 0;
  box-sizing:border-box;
  border-radius:5px;
  border:1px solid #666;
  background:#222;
  color:white;
}

.tradeCharItem{
  padding:8px;
  margin:5px 0;
  border:1px solid #555;
  border-radius:5px;
  cursor:pointer;
  background:#222;
}

.tradeCharItem.selected{
  background:#4CAF50;
  color:black;
}

.tradeList{
  max-height:300px;
  overflow-y:auto;
  border:1px solid #555;
  border-radius:5px;
  padding:8px;
  margin:10px 0;
}

.tradeOffer{
  padding:10px;
  margin:8px 0;
  border:1px solid #888;
  border-radius:5px;
  background:#222;
}

.tradeOffer.pending{
  border-color:#ff9800;
  background:#2a2000;
}

.tradeOffer.waiting{
  border-color:#2196F3;
  background:#002a3a;
}

#fuseArea{
  position:fixed;
  bottom:20px;
  right:20px;
  width:300px;
  max-height:650px;
  border:4px solid #2196F3;
  background:#1e1e1e;
  display:none;
  flex-direction:column;
  padding:15px;
  border-radius:15px;
  z-index:3000;
  box-shadow:0 0 25px black;
}

#fuseArea h3{
  margin-top:0;
  color:#2196F3;
}

#fuseSlots{
  flex:1;
  overflow-y:auto;
  max-height:400px;
}

#tradeToggleBtn{
  position:fixed;
  top:15px;
  right:20px;
  padding:12px 18px;
  background:#4CAF50;
  color:white;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  z-index:2000;
}

#fuseToggleBtn{
  position:fixed;
  bottom:15px;
  right:20px;
  padding:12px 18px;
  background:#2196F3;
  color:white;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  z-index:2000;
}

#adminPanel{
  display:none;
  position:absolute;
  right:5px;
  top:120px;
  width:260px;
  background:#111;
  border:3px solid gold;
  padding:15px;
  z-index:1000;
  cursor:move;
}

#adminPanel button{
  width:100%;
  margin:5px 0;
  padding:8px;
}

#adminEventBanner{
  display:none;
  position:fixed;
  right:20px;
  bottom:80px;
  background:linear-gradient(45deg,gold,orange);
  color:black;
  font-weight:bold;
  padding:12px 20px;
  border-radius:10px;
  box-shadow:0 0 15px gold;
  z-index:2000;
  animation:pulse 1s infinite alternate;
}

@keyframes pulse{
  from { transform:scale(1); box-shadow:0 0 10px gold; }
  to { transform:scale(1.08); box-shadow:0 0 25px orange; }
}

#codeBox{
  margin:10px;
}

#codeBox input{
  padding:5px;
  border-radius:5px;
  border:1px solid #666;
  background:#222;
  color:white;
  width:150px;
}

#codeBox button{
  padding:5px 10px;
  margin:0 5px;
}

button{
  background:#444;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:5px;
  cursor:pointer;
  font-weight:bold;
}

button:hover{
  background:#666;
}

.toast {
  position:fixed;
  bottom:100px;
  right:20px;
  background:rgba(0,0,0,0.9);
  color:white;
  padding:15px 20px;
  border-radius:10px;
  border-left:4px solid #4CAF50;
  z-index:4999;
  animation: slideIn 0.4s ease-out;
  max-width:300px;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity:0; }
  to { transform: translateX(0); opacity:1; }
}

#dialogBackdrop {
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.7);
  z-index:4998;
  display:none;
}

#dialogBox {
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  background:#1e1e1e;
  padding:30px;
  border-radius:15px;
  border:2px solid #4CAF50;
  box-shadow:0 0 30px rgba(76,175,80,0.5);
  z-index:4999;
  display:none;
  max-width:400px;
  text-align:center;
  color:white;
}

#dialogBox.show {
  display:block;
}

#dialogBox h3 {
  margin-top:0;
  color:#4CAF50;
  font-size:24px;
}

#dialogBox .buttons {
  margin-top:20px;
  display:flex;
  gap:10px;
}

#dialogBox button {
  flex:1;
  padding:10px;
}

#dialogBox button.confirm {
  background:#4CAF50;
}

#dialogBox button.cancel {
  background:#666;
}
</style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCs4uhyRzBC8nSJrwWrd_fBdzIJjR7D3A0",
  authDomain: "brainrot-3e022.firebaseapp.com",
  databaseURL: "https://brainrot-3e022-default-rtdb.firebaseio.com",
  projectId: "brainrot-3e022",
  storageBucket: "brainrot-3e022.firebasestorage.app",
  messagingSenderId: "489333416512",
  appId: "1:489333416512:web:1652e3f5cb8d3801ee75a5",
  measurementId: "G-HCFMTTL0WV"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
</script>

<div id="ui">
  <div>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ <span id="money">0</span></div>
  <div>ãƒªãƒãƒ¼ã‚¹ <span id="level">1</span></div>
  <div>å®¹é‡ <span id="cap">10</span></div>
  <div>å€ç‡ x<span id="multiplier">1</span></div>
  <button id="upgradeBtn" onclick="upgradeBase()" style="width:100%; margin-top:8px;">ãƒªãƒãƒ¼ã‚¹</button>
  <button onclick="showResetDialog()" style="background:#d32f2f; width:100%; margin-top:3px;">ãƒªã‚»ãƒƒãƒˆ</button>
  <hr>
  <div id="codeBox">
    <button onclick="openCodePrompt()">ã‚³ãƒ¼ãƒ‰</button>

<script>
function openCodePrompt(){
  const code = prompt("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›");

  if(!code) return;

  if(code === "0402810"){
    isAdmin = true;
    document.body.style.boxShadow = "0 0 40px gold inset";
    document.getElementById("adminPanel").style.display = "block";
    showToast("ğŸ‘‘ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ON", "success");
  } else {
    showToast("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™", "error");
  }
}
</script>
  </div>
</div>

<<div id="adminPanel">
  <h3 style="color:gold;">ğŸ‘‘ ç®¡ç†è€…ãƒ‘ãƒãƒ«</h3>

  <button onclick="addMoney(100000000)" style="background:#4CAF50;">ğŸ’° +100M</button>
  <button onclick="addMoney(1000000000)" style="background:#4CAF50;">ğŸ’° +1B</button>
  <button onclick="addMoney(10000000000)" style="background:#4CAF50;">ğŸ’° +10B</button>

  <hr>

  <button onclick="startAdminEvent()" style="background:#ff9800;">ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹</button>
  <button onclick="stopAdminEvent()" style="background:#d32f2f;">ğŸ›‘ ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†</button>

  <hr>
  

  <button onclick="closeAdminPanel()" style="background:#555;">âŒ é–‰ã˜ã‚‹</button>

  <div id="eventStatus" style="margin-top:10px;color:lime;">ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­</div>
</div>

<div id="carpet"></div>
<div id="base"></div>

<button id="tradeToggleBtn" onclick="toggleTradePanel()">ğŸ”„ ã‚­ãƒ£ãƒ©äº¤æ›</button>
<button id="fuseToggleBtn" onclick="toggleFusePanel()">ğŸ§ª åˆæˆ</button>

<div id="tradePanel">
  <h3>ğŸŒ ã‚­ãƒ£ãƒ©äº¤æ›</h3>
  <button onclick="toggleTradePanel()" 
style="
position:absolute;
top:10px;
right:10px;
background:#d32f2f;
padding:6px 10px;
border-radius:8px;
">
âœ•
</button>
  <div style="display:flex; gap:5px; margin-bottom:10px;">
    <button onclick="switchTradeTab('offer')" id="tabOffer" style="flex:1; background:#4CAF50;">ğŸ“¤ å‡ºå“</button>
    <button onclick="switchTradeTab('find')" id="tabFind" style="flex:1; background:#666;">ğŸ” å‹Ÿé›†</button>
  </div>
  <div id="offerTab">
    <h4>è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‹ã‚‰é¸æŠ</h4>
    <div class="tradeList" id="myCharList"></div>
    <label>å‹Ÿé›†èª¬æ˜:</label>
    <input type="text" id="tradeMessage" placeholder="ä¾‹ï¼šã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆæ±‚ã‚€ï¼">
    <button onclick="postTrade()" style="width:100%; background:#4CAF50;">ğŸ“¤ å‡ºå“ã™ã‚‹</button>
    <hr>
    <h4>äº¤æ›ç”³è«‹</h4>
    <div class="tradeList" id="incomingRequests"></div>
  </div>
  <div id="findTab" style="display:none;">
    <h4>å‹Ÿé›†ä¸­ã®äº¤æ›</h4>
    <div class="tradeList" id="publicTradesList"></div>
  </div>
  
</div>

<div id="fuseArea">
  <h3>ğŸ§ª ãƒã‚·ãƒ¼ãƒ³</h3>
  <div>åˆè¨ˆåç›Š: <span id="fuseTotal">0</span>/s</div>
  <div id="fuseSlots"></div>
  <button onclick="fuse()" style="width:100%; background:#2196F3; margin-top:8px;">åˆæˆ</button>
  <button onclick="toggleFusePanel()" style="width:100%; margin-top:5px; background:#d32f2f;">âœ• é–‰ã˜ã‚‹</button>
</div>

<div id="adminEventBanner">
  ğŸ‘‘ ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•ä¸­<br>
  â³ æ®‹ã‚Šæ™‚é–“: <span id="adminEventTime">--:--</span>
</div>
<div id="notificationPanel"></div>
<div id="dialogBackdrop"></div>
<div id="dialogBox">
  <h3 id="dialogTitle">ç¢ºèª</h3>
  <p id="dialogMessage"></p>
  <div class="buttons">
    <button class="confirm" onclick="confirmDialog()">ã¯ã„</button>
    <button class="cancel" onclick="cancelDialog()">ã„ã„ãˆ</button>
  </div>
</div>

<script>
let playerId = localStorage.getItem("playerId");
if(!playerId){
  playerId = "player_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("playerId", playerId);
}

let adminEventActive = false, globalLuckMultiplier = 1, isAdmin = false;
let usedCodes = JSON.parse(localStorage.getItem("usedCodes")||"[]");
let selectedMyChar = null, currentTradeTab = "offer", dialogCallback = null;
let eventCountdownInterval = null;

const rarities = [
  {name:"COMMON", color:"#777", rate:1000, chance:49},
  {name:"RARE", color:"blue", rate:5000, chance:26},
  {name:"EPIC", color:"purple", rate:20000, chance:14},
  {name:"LEGENDARY", color:"gold", rate:80000, chance:7},
  {name:"MYTHIC", color:"orange", rate:200000, chance:3},
  {name:"GOD", color:"rainbow", rate:1000000, chance:0.8},
  {name:"SECRET", color:"black", rate:0, chance:0.2}
];

const attributes = [
  {name:"Default", multiplier:1, chance:85, color:"#444"},
  {name:"Gold", multiplier:1.5, chance:5, color:"gold"},
  {name:"Diamond", multiplier:3, chance:3, color:"cyan"},
  {name:"Galaxy", multiplier:5, chance:2, color:"magenta"},
  {name:"Dreamy", multiplier:7, chance:1.5, color:"pink"},
  {name:"Lava", multiplier:8, chance:1, color:"red"},
  {name:"Aqua", multiplier:9, chance:0.8, color:"blue"},
  {name:"Rainbow", multiplier:10, chance:0.5, color:"orange"},
  {name:"Netherite", multiplier:10, chance:0.4, color:"gray"},
  {name:"Amethyst", multiplier:10.5, chance:0.3, color:"purple"},
  {name:"Toxic", multiplier:11, chance:0.3, color:"lime"},
  {name:"Ultimate", multiplier:12, chance:0.2, color:"white"}
];

const mutations = [
  {name:"Lightning", bonus:2, icon:"âš¡"},
  {name:"Ice", bonus:2, icon:"ğŸ§Š"},
  {name:"Nether", bonus:2.5, icon:"ğŸ”¥"},
  {name:"End", bonus:3, icon:"ğŸŒŒ"},
  {name:"Enchant", bonus:3, icon:"âœ¨"},
  {name:"Inmu", bonus:4, icon:"â˜ "}
];

const secretCharacters = [
  {character:"Piccione Macchina", rate:500000},{character:"Pakrahmatmamat", rate:600000},{character:"Orcalero Orcala", rate:1000000},{character:"Pot Hotspot", rate:2000000},{character:"Nooo My Hotspot", rate:2500000},{character:"Garamaramadungdung", rate:3000000},{character:"Il Sacro Cabrospaghetti", rate:4000000},{character:"La Grande Combinacion", rate:5000000},{character:"Yess My Hotspot", rate:5500000},{character:"67", rate:6700000},{character:"69", rate:13800000},{character:"Ketupat Kepat Prekupat", rate:10000000},{character:"Nooo My Bicicleteira", rate:13500000},{character:"W or L", rate:13000000},{character:"Lirili Ralilu", rate:17000000},{character:"La Esok Sekolah", rate:20000000},{character:"Chimpanzini Kingini", rate:25000000},{character:"Strawberry Elephant", rate:30000000},{character:"Klombo", rate:32000000},{character:"Gorgonzilla", rate:57000000},{character:"Spaghetti Tualetti", rate:40000000},{character:"Cannelloni Dragoni", rate:50000000},{character:"La Crazy Combinacion", rate:60000000},{character:"Chocone Dragone", rate:80000000},{character:"Gigalitraktos Spidorobos", rate:75000000},{character:"Tiramisubmarini", rate:90000000},{character:"Garbagzilla", rate:100000000},{character:"Cannone Maledettone", rate:115000000},{character:"SKIBIDI TOILET", rate:350000000},{character:"YAJUU SENPAI", rate:810000000}
];
const reverseRequirements = {
  2: "EPIC",
  3: "LEGENDARY",
  4: "MYTHIC",
  5: "GOD",
  6: "Orcalero Orcala",
  7: "Pot Hotspot",
  8: "Garamaramadungdung",
  9: "La Grande Combinacion",
  10: "67",
  11: "69",
  12: "Lirili Ralilu",
  13: "La Esok Sekolah",
  14: "Strawberry Elephant",
  15: "Spaghetti Tualetti",
  16: "Cannelloni Dragoni",
  17: "La Crazy Combinacion",
  18: "Gigalitraktos Spidorobos",
  19: "Tiramisubmarini",
  20: "Cannone Maledettone",
  21: "SKIBIDI TOILET"
};

function reverseCharacter(char){

  const nextLevel = char.reverse + 1;
  const required = reverseRequirements[nextLevel];

  if(!required){
    alert("ã“ã‚Œä»¥ä¸Šå¼·åŒ–ã§ãã¾ã›ã‚“");
    return;
  }

  // å¿…è¦ã‚­ãƒ£ãƒ©ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèª
  const index = inventory.findIndex(c => 
    c.name === required || c.rarity === required
  );

  if(index === -1){
    alert("å¿…è¦ã‚­ãƒ£ãƒ©ãŒè¶³ã‚Šã¾ã›ã‚“: " + required);
    return;
  }

  // å¿…è¦ã‚­ãƒ£ãƒ©æ¶ˆè²»
  inventory.splice(index,1);

  char.reverse++;
  alert("ğŸ”¥ ãƒªãƒãƒ¼ã‚¹" + char.reverse + " ã«é€²åŒ–ï¼");
  updateUI();
}

let adminEventActive = false;
let adminEventEndTime = 0;
let adminInterval = null;

function startAdminEvent(){

  adminEventActive = true;
  adminEventEndTime = Date.now() + 5 * 60 * 1000; // 5åˆ†

  alert("ğŸ‘‘ ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ï¼");

  if(adminInterval) clearInterval(adminInterval);

  adminInterval = setInterval(()=>{
    const remain = adminEventEndTime - Date.now();

    if(remain <= 0){
      adminEventActive = false;
      clearInterval(adminInterval);
      document.getElementById("adminTimer").innerText = "çµ‚äº†";
      alert("ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†");
      return;
    }

    const sec = Math.floor(remain/1000);
    document.getElementById("adminTimer").innerText = sec + " ç§’";

  },1000);
}

const fuseTable = [
  {min:0, max:10000, results:[{type:"rarity", value:"COMMON", chance:25},{type:"rarity", value:"RARE", chance:35},{type:"rarity", value:"EPIC", chance:40}]},
  {min:10000, max:50000, results:[{type:"rarity", value:"COMMON", chance:20},{type:"rarity", value:"RARE", chance:25},{type:"rarity", value:"EPIC", chance:55}]},
  {min:50000, max:350000, results:[{type:"rarity", value:"RARE", chance:35},{type:"rarity", value:"EPIC", chance:50},{type:"rarity", value:"LEGENDARY", chance:25}]},
  {min:350000, max:1000000, results:[{type:"rarity", value:"EPIC", chance:25},{type:"rarity", value:"LEGENDARY", chance:40},{type:"rarity", value:"MYTHIC", chance:25},{type:"rarity", value:"GOD", chance:10}]},
  {min:1000000, max:2000000, results:[{type:"rarity", value:"MYTHIC", chance:35},{type:"rarity", value:"GOD", chance:55},{type:"secret", value:"Pot Hotspot", chance:10}]},
  {min:2000000, max:5000000, results:[{type:"rarity", value:"GOD", chance:25},{type:"secret", value:"Pot Hotspot", chance:35},{type:"secret", value:"Garamaramadungdung", chance:25},{type:"secret", value:"La Grande Combinacion", chance:15}]},
  {min:5000000, max:10000000, results:[{type:"secret", value:"Pot Hotspot", chance:25},{type:"secret", value:"67", chance:35},{type:"secret", value:"69", chance:30},{type:"secret", value:"Lirili Ralilu", chance:10}]},
  {min:10000000, max:15000000, results:[{type:"secret", value:"67", chance:30},{type:"secret", value:"69", chance:25},{type:"secret", value:"Lirili Ralilu", chance:30},{type:"secret", value:"La Esok Sekolah", chance:15}]},
  {min:15000000, max:25000000, results:[{type:"secret", value:"Lirili Ralilu", chance:35},{type:"secret", value:"La Esok Sekolah", chance:45},{type:"secret", value:"Chimpanzini Kingini", chance:15},{type:"secret", value:"Gorgonzilla", chance:5}]},
  {min:25000000, max:35000000, results:[{type:"secret", value:"La Esok Sekolah", chance:35},{type:"secret", value:"Chimpanzini Kingini", chance:40},{type:"secret", value:"Spaghetti Tualetti", chance:18},{type:"secret", value:"Gorgonzilla", chance:10},{type:"secret", value:"La Crazy Combinacion", chance:2}]},
  {min:35000000, max:45000000, results:[{type:"secret", value:"Chimpanzini Kingini", chance:45},{type:"secret", value:"Spaghetti Tualetti", chance:35},{type:"secret", value:"Gorgonzilla", chance:15},{type:"secret", value:"La Crazy Combinacion", chance:5}]},
  {min:45000000, max:65000000, results:[{type:"secret", value:"Spaghetti Tualetti", chance:45},{type:"secret", value:"Gorgonzilla", chance:25},{type:"secret", value:"La Crazy Combinacion", chance:25},{type:"secret", value:"Gigalitraktos Spidorobos", chance:5}]},
  {min:65000000, max:100000000, results:[{type:"secret", value:"Spaghetti Tualetti", chance:35},{type:"secret", value:"Gorgonzilla", chance:25},{type:"secret", value:"La Crazy Combinacion", chance:20},{type:"secret", value:"Gigalitraktos Spidorobos", chance:19},{type:"secret", value:"YAJUU SENPAI", chance:1}]},
  {min:100000000, max:300000000, results:[{type:"secret", value:"Gorgonzilla", chance:45},{type:"secret", value:"La Crazy Combinacion", chance:35},{type:"secret", value:"Gigalitraktos Spidorobos", chance:15},{type:"secret", value:"YAJUU SENPAI", chance:5}]},
  {min:300000000, max:500000000, results:[{type:"secret", value:"Gorgonzilla", chance:25},{type:"secret", value:"La Crazy Combinacion", chance:40},{type:"secret", value:"Gigalitraktos Spidorobos", chance:25},{type:"secret", value:"YAJUU SENPAI", chance:10}]},
  {min:500000000, max:Infinity, results:[{type:"secret", value:"La Crazy Combinacion", chance:45},{type:"secret", value:"Gigalitraktos Spidorobos", chance:35},{type:"secret", value:"YAJUU SENPAI", chance:20}]}
];

let money=0, baseLevel=1, capacity=10, incomeMultiplier=1, base=[], fuseList=[], spawnInterval;

function renderReverseRequirement(char){

  const nextLevel = char.reverse + 1;
  const required = reverseRequirements[nextLevel];

  if(!required){
    return "<div style='color:gold;'>â˜… æœ€å¤§ãƒ¬ãƒ™ãƒ«</div>";
  }

  const hasRequired = inventory.some(c =>
    c.name === required || c.rarity === required
  );

  const color = hasRequired ? "lime" : "red";
  const status = hasRequired ? "æ‰€æŒã—ã¦ã„ã¾ã™" : "æŒã£ã¦ã„ã¾ã›ã‚“";

  return `
    <div style="margin-top:8px;">
      ğŸ”¥ æ¬¡ã®ãƒªãƒãƒ¼ã‚¹${nextLevel}ã«å¿…è¦:
      <div style="color:${color}; font-weight:bold;">
        ${required}
      </div>
      <div style="font-size:12px; color:${color};">
        ${status}
      </div>
    </div>
  `;
}

function showNotification(message, type = "success", duration = 3000) {
  const panel = document.getElementById("notificationPanel");
  panel.textContent = message;
  panel.className = type;
  panel.style.display = "block";
  setTimeout(() => { panel.style.display = "none"; }, duration);
}

function showToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.animation = "slideOut 0.4s"; setTimeout(() => toast.remove(), 400); }, 3000);
}

function showDialog(title, message, callback) {
  document.getElementById("dialogTitle").textContent = title;
  document.getElementById("dialogMessage").textContent = message;
  document.getElementById("dialogBox").classList.add("show");
  document.getElementById("dialogBackdrop").style.display = "block";
  dialogCallback = callback;
}

function confirmDialog() {
  document.getElementById("dialogBox").classList.remove("show");
  document.getElementById("dialogBackdrop").style.display = "none";
  if(dialogCallback) dialogCallback(true);
  dialogCallback = null;
}

function cancelDialog() {
  document.getElementById("dialogBox").classList.remove("show");
  document.getElementById("dialogBackdrop").style.display = "none";
  if(dialogCallback) dialogCallback(false);
  dialogCallback = null;
}

function format(num){
  if(num>=1e42) return (num/1e42).toFixed(1)+"TD";
  if(num>=1e39) return (num/1e39).toFixed(1)+"DD";
  if(num>=1e36) return (num/1e36).toFixed(1)+"UD";
  if(num>=1e33) return (num/1e33).toFixed(1)+"DC";
  if(num>=1e30) return (num/1e30).toFixed(1)+"NO";
  if(num>=1e27) return (num/1e27).toFixed(1)+"OC";
  if(num>=1e24) return (num/1e24).toFixed(1)+"SP";
  if(num>=1e21) return (num/1e21).toFixed(1)+"SX";
  if(num>=1e18) return (num/1e18).toFixed(1)+"QI";
  if(num>=1e15) return (num/1e15).toFixed(1)+"QA";
  if(num>=1e12) return (num/1e12).toFixed(1)+"T";
  if(num>=1e9) return (num/1e9).toFixed(1)+"B";
  if(num>=1e6) return (num/1e6).toFixed(1)+"M";
  if(num>=1e3) return (num/1e3).toFixed(1)+"K";
  return Math.floor(num);
}

function getCharName(c){ return c.name === "SECRET" ? c.character : c.name; }

function getCharDisplay(c){
  let attr = c.attribute ? c.attribute.name : "Default";
  let rate = format(c.rate) + "/s";
  let mutations = (c.mutations && c.mutations.length > 0) ? c.mutations.map(m=>m.icon).join("") : "";
  return `[${attr}] ${getCharName(c)} ${mutations} +${rate}`;
}

function ensureBaseSlots(){
  while(base.length < capacity) base.push(null);
  if(base.length > capacity) base = base.slice(0, capacity);
}

function updateUI(){
  const cost = Math.floor(50000*Math.pow(4, baseLevel-1));
  document.getElementById("money").innerText = format(money);
  document.getElementById("level").innerText = baseLevel;
  document.getElementById("cap").innerText = capacity;
  document.getElementById("multiplier").innerText = incomeMultiplier.toFixed(1);
  document.getElementById("upgradeBtn").innerText = "ãƒªãƒãƒ¼ã‚¹ (" + format(cost) + ")";
}

function toggleTradePanel(){
  const panel = document.getElementById("tradePanel");
  const fuseArea = document.getElementById("fuseArea");
  if(panel.style.display === "block"){ panel.style.display = "none"; }
  else { panel.style.display = "block"; fuseArea.style.display = "none"; renderTradePanel(); }
}

function toggleFusePanel(){
  const fuseArea = document.getElementById("fuseArea");
  const panel = document.getElementById("tradePanel");
  if(fuseArea.style.display === "flex"){ fuseArea.style.display = "none"; }
  else { fuseArea.style.display = "flex"; panel.style.display = "none"; }
}

function switchTradeTab(tab){
  currentTradeTab = tab;
  document.getElementById("offerTab").style.display = tab === "offer" ? "block" : "none";
  document.getElementById("findTab").style.display = tab === "find" ? "block" : "none";
  document.getElementById("tabOffer").style.background = tab === "offer" ? "#4CAF50" : "#666";
  document.getElementById("tabFind").style.background = tab === "find" ? "#2196F3" : "#666";
  if(tab === "find") renderPublicTrades();
}

function showResetDialog(){
  showDialog("ãƒªã‚»ãƒƒãƒˆç¢ºèª", "æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ", (confirmed) => {
    if(confirmed){
      money=0; baseLevel=1; capacity=10; incomeMultiplier=1; base=[]; fuseList=[];
      ensureBaseSlots(); renderBase(); renderFuse(); updateUI();
      showToast("âœ… ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", "success");
    }
  });
}

function getRandomRarity(){
  const adjusted = rarities.map(r=>({...r, chance: r.chance * globalLuckMultiplier }));
  const total = adjusted.reduce((s,r)=>s+r.chance,0);
  const rand = Math.random()*total;
  let sum=0;
  for(let r of adjusted){ sum+=r.chance; if(rand<=sum) return r; }
}

function showCharacterReverse(char){

  let html = `
    <h3>ğŸ”¥ ã‚­ãƒ£ãƒ©å¼·åŒ–</h3>
    <div>${getCharDisplay(char)}</div>
  `;

  html += renderReverseRequirement(char);

  html += `
    <button onclick="reverseCharacterFromUI()">ãƒªãƒãƒ¼ã‚¹</button>
    <button onclick="closeCharacterReverse()">é–‰ã˜ã‚‹</button>
  `;

  const box = document.createElement("div");
  box.id = "reverseBox";
  box.style.position = "fixed";
  box.style.left = "50%";
  box.style.top = "50%";
  box.style.transform = "translate(-50%, -50%)";
  box.style.background = "#111";
  box.style.padding = "20px";
  box.style.border = "2px solid gold";
  box.style.zIndex = "5000";
  box.innerHTML = html;

  document.body.appendChild(box);

  window.currentReverseChar = char;
}

function reverseCharacterFromUI(){
  if(!window.currentReverseChar) return;
  reverseCharacter(window.currentReverseChar);
  closeCharacterReverse();
}

function closeCharacterReverse(){
  const box = document.getElementById("reverseBox");
  if(box) box.remove();
}

function spawnWalker(){
  let baseData = getRandomRarity();
  let data = {...baseData};
  if(baseData.name === "SECRET"){
    const pick = secretCharacters[Math.floor(Math.random()*secretCharacters.length)];
    data = {name:"SECRET", character: pick.character, rate: pick.rate, color:"black"};
  }
  let totalChance = attributes.reduce((s,a)=>s+a.chance,0);
  let rand = Math.random()*totalChance;
  let sum = 0;
  for(let attr of attributes){ sum += attr.chance; if(rand <= sum){ data.attribute = attr; break; }}
  
  data.mutations = [];
  if(adminEventActive){
    mutations.forEach(m=>{ if(Math.random()<0.15) data.mutations.push(m); });
  }
  let totalMultiplier = data.attribute.multiplier;
  data.mutations.forEach(m=>totalMultiplier += m.bonus);
  data.rate = Math.floor(data.rate * totalMultiplier);

  const div = document.createElement("div");
  div.className = "walker";
  div.style.background = data.attribute ? data.attribute.color : "#444";
  div.style.border = "2px solid white";

  let attributeName = data.attribute ? data.attribute.name : "Default";
  let rarityText = data.name === "SECRET" ? data.character : data.name;
  const raritySpan = document.createElement("span");
  raritySpan.innerText = rarityText;
  switch(data.name){
    case "COMMON": raritySpan.style.background="#6b3e1d"; break;
    case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
    case "EPIC": raritySpan.style.background="purple"; break;
    case "LEGENDARY": raritySpan.style.background="yellow"; break;
    case "MYTHIC": raritySpan.style.background="gold"; break;
    case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
    case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
  }
  raritySpan.style.padding="2px 6px"; raritySpan.style.borderRadius="6px"; raritySpan.style.fontSize="10px";
  let mutationIcons = (data.mutations && data.mutations.length > 0) ? data.mutations.map(m=>m.icon).join("") : "";
  div.innerHTML = "<div>[" + attributeName + "]</div><div>" + raritySpan.outerHTML + "</div><div>+" + format(data.rate) + "/s</div>";
  div.style.top = "-100px";
  document.body.appendChild(div);
  let pos=-100;
  const move = setInterval(()=>{
    pos += 1;
    div.style.top = pos + "px";
    if(pos>window.innerHeight){ div.remove(); clearInterval(move); }
  },30);
  div.onclick = ()=>{
    const emptyIndex = base.findIndex(s=>s===null);
    if(emptyIndex!==-1){ base[emptyIndex]=data; renderBase(); div.remove(); clearInterval(move); }
  };
  data.baseRate = data.rate;
}

function renderBase(){
  const baseDiv = document.getElementById("base");
  baseDiv.innerHTML = "";
  base.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className = "char";
    if(c){
      div.style.background = c.attribute ? c.attribute.color : "#444";
      div.style.border = "1px solid #333";
      let mutationIcons = (c.mutations && c.mutations.length > 0) ? c.mutations.map(m=>m.icon).join("") : "";
      let attributeName = c.attribute ? c.attribute.name : "Default";
      let rarityText = c.name === "SECRET" ? c.character : c.name;
      const raritySpan = document.createElement("span");
      raritySpan.innerText = rarityText;
      switch(c.name){
        case "COMMON": raritySpan.style.background="#6b3e1d"; break;
        case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
        case "EPIC": raritySpan.style.background="purple"; break;
        case "LEGENDARY": raritySpan.style.background="yellow"; break;
        case "MYTHIC": raritySpan.style.background="gold"; break;
        case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
        case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
      }
      raritySpan.style.padding="2px 6px"; raritySpan.style.borderRadius="6px"; raritySpan.style.fontSize="10px";
      div.innerHTML = "<div>[" + attributeName + "]</div><div>" + raritySpan.outerHTML + "</div><div>" + mutationIcons + " +" + format(c.rate) + "/s</div>";
     div.onclick = ()=>{
  showCharacterReverse(c);
};
      div.oncontextmenu = (e)=>{ e.preventDefault(); base[i] = null; renderBase(); };
    } else {
      div.style.background = "#111";
      div.style.border = "1px dashed #333";
    }
    baseDiv.appendChild(div);
  });
}

function renderFuse(){
  const fuseDiv = document.getElementById("fuseSlots");
  fuseDiv.innerHTML = "";
  let total = 0;
  let totalBase = 0;
  
  fuseList.forEach((c)=>{
    total += c.rate;
    totalBase += (c.baseRate || c.rate);
    const div = document.createElement("div");
    div.className = "char";
    div.style.background = c.attribute ? c.attribute.color : "#444";
    div.style.fontSize = "11px";
    let mutationIcons = (c.mutations && c.mutations.length > 0) ? c.mutations.map(m=>m.icon).join("") : "";
    let attributeName = c.attribute ? c.attribute.name : "Default";
    let rarityText = c.name === "SECRET" ? c.character : c.name;
    const raritySpan = document.createElement("span");
    raritySpan.innerText = rarityText;
    switch(c.name){
      case "COMMON": raritySpan.style.background="#6b3e1d"; break;
      case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
      case "EPIC": raritySpan.style.background="purple"; break;
      case "LEGENDARY": raritySpan.style.background="yellow"; break;
      case "MYTHIC": raritySpan.style.background="gold"; break;
      case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
      case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
    }
    raritySpan.style.padding="2px 6px"; raritySpan.style.borderRadius="6px"; raritySpan.style.fontSize="10px";
    div.innerHTML = "<div style='font-size:10px;'>[" + attributeName + "]</div><div>" + raritySpan.outerHTML + "</div><div>" + mutationIcons + " +" + format(c.rate) + "/s</div>";
    div.onclick = ()=>{ const emptyIndex = base.findIndex(s=>s===null); if(emptyIndex === -1) return; const index = fuseList.indexOf(c); if(index !== -1) fuseList.splice(index,1); base[emptyIndex] = c; renderBase(); renderFuse(); };
    fuseDiv.appendChild(div);
  });
  
  document.getElementById("fuseTotal").innerText = format(totalBase);

  if(fuseList.length > 0){
    const totalBaseRate = fuseList.reduce((sum,c)=>sum+(c.baseRate||c.rate),0);
    const table = fuseTable.find(t => totalBaseRate >= t.min && totalBaseRate < t.max);
    if(table){
      const chanceDiv = document.createElement("div");
      chanceDiv.style.marginTop = "8px"; chanceDiv.style.fontSize = "10px"; chanceDiv.style.padding = "8px"; chanceDiv.style.background = "#333"; chanceDiv.style.borderRadius = "5px";
      chanceDiv.innerHTML = "<b>åˆæˆçµæœç¢ºç‡</b><br>";
      const totalChance = table.results.reduce((s,r)=>s+r.chance,0);
      table.results.forEach(r=>{ let name = r.type === "secret" ? r.value : r.value; let percent = Math.round(r.chance / totalChance * 100); chanceDiv.innerHTML += name + " : " + percent + "%<br>"; });
      fuseDiv.appendChild(chanceDiv);
    }
  }
}

function fuse(){
  if(fuseList.length !== 5) { showNotification(`âš ï¸ 5ä½“å¿…è¦ã§ã™ï¼ï¼ˆç¾åœ¨ ${fuseList.length}/5ï¼‰`, "error", 2000); return; }
  const used = fuseList.splice(0,5);
  
  const totalBaseRate = used.reduce((sum,c)=>sum + (c.baseRate || c.rate),0);
  
  const table = fuseTable.find(t => totalBaseRate >= t.min && totalBaseRate < t.max);
  if(!table){ renderFuse(); return; }
  
  const totalChance = table.results.reduce((s,r)=>s+r.chance,0);
  const rand = Math.random() * totalChance;
  let sum = 0, chosen = table.results[0];
  for(let r of table.results){ sum += r.chance; if(rand <= sum){ chosen = r; break; }}
  
  let newChar;
  if(chosen.type === "rarity"){
    const rarityData = rarities.find(r => r.name === chosen.value);
    newChar = {...rarityData};
    newChar.baseRate = rarityData.rate;
  } else {
    const secretData = secretCharacters.find(s => s.character === chosen.value);
    newChar = {name:"SECRET", character: secretData.character, color:"black", baseRate: secretData.rate};
  }
  
  const firstChar = used[0];
  newChar.attribute = firstChar.attribute;
  newChar.mutations = firstChar.mutations ? [...firstChar.mutations] : [];
  
  let totalMultiplier = newChar.attribute ? newChar.attribute.multiplier : 1;
  newChar.mutations.forEach(m => totalMultiplier += m.bonus);
  newChar.rate = Math.floor(newChar.baseRate * totalMultiplier);
  
  const emptyIndex = base.findIndex(s=>s===null);
  if(emptyIndex !== -1){ base[emptyIndex] = newChar; } else { fuseList.push(newChar); }
  renderBase(); renderFuse();
  showToast(`âœ¨ ${getCharName(newChar)} ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼`, "success");
}

function upgradeBase(){
  const cost=Math.floor(50000*Math.pow(4,baseLevel-1));
  if(money>=cost){ money=0; baseLevel++; capacity+=1; incomeMultiplier+=0.5; ensureBaseSlots(); renderBase(); updateUI(); showToast("ğŸ“ˆ ãƒªãƒãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ãŒä¸ŠãŒã‚Šã¾ã—ãŸï¼", "success"); }
  else { showNotification(`ğŸ’° ${format(cost - money)} è¶³ã‚Šã¾ã›ã‚“`, "error", 2000); }
}

function startAdminEvent(){
  if(!isAdmin) return;
  const endTime = Date.now() + (20 * 60 * 1000);
  db.ref("globalEvent").set({active: true, luck: 100, startTime: Date.now(), endTime: endTime});
  showToast("ğŸ‘‘ ã‚¤ãƒ™ãƒ³ãƒˆã‚’é–‹å§‹ã—ã¾ã—ãŸ", "success");
}

function stopAdminEvent(){
  if(!isAdmin) return;
  db.ref("globalEvent").set({active:false});
  showToast("ğŸ‘‘ ã‚¤ãƒ™ãƒ³ãƒˆã‚’çµ‚äº†ã—ã¾ã—ãŸ", "info");
}

function addMoney(amount){
  if(!isAdmin) return;
  money += amount;
  updateUI();
  showToast("ğŸ’° " + format(amount) + " è¿½åŠ ã—ã¾ã—ãŸ", "success");
}

function closeAdminPanel(){
  document.getElementById("adminPanel").style.display = "none";
}

function useCode(){
  const input = document.getElementById("codeInput");
  const code = input.value.trim();
  input.value = "";
  if(!code) return;
  if(!isAdmin && usedCodes.includes(code)){ showNotification("âŒ ã“ã®ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«ä½¿ç”¨æ¸ˆã¿ã§ã™ï¼", "error", 2000); return; }
  if(code === "670402"){
    isAdmin = true;
    document.getElementById("adminPanel").style.display = "block";
    showNotification("âœ… ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰èµ·å‹•", "success", 2000);
    return;
  }
  if(!isAdmin){ usedCodes.push(code); localStorage.setItem("usedCodes",JSON.stringify(usedCodes)); showToast("âœ… ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¾ã—ãŸï¼", "success"); }
}

function renderTradePanel(){
  renderMyCharList();
  renderIncomingRequests();
}

function renderMyCharList(){
  const container = document.getElementById("myCharList");
  container.innerHTML = "";
  base.forEach((c, i)=>{
    if(!c) return;
    const div = document.createElement("div");
    div.className = "tradeCharItem";
    if(i === selectedMyChar) div.classList.add("selected");
    div.innerHTML = `<div><strong>[${i}] ${getCharName(c)}</strong></div><div style="font-size:11px;">${getCharDisplay(c)}</div>`;
    div.onclick = ()=>{ selectedMyChar = (selectedMyChar === i) ? null : i; renderMyCharList(); };
    container.appendChild(div);
  });
}

function postTrade(){
  if(selectedMyChar === null){ showNotification("âš ï¸ ã‚­ãƒ£ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼", "error", 2000); return; }
  
  db.ref("publicTrades").once("value").then(snap=>{
    const trades = snap.val();
    let myActiveListings = 0;
    if(trades){
      Object.values(trades).forEach(trade=>{
        if(trade.owner === playerId && trade.status === "open") myActiveListings++;
      });
    }
    
    if(myActiveListings >= 2){
      showNotification("âš ï¸ åŒæ™‚ã«å‡ºå“ã§ãã‚‹ã®ã¯2å€‹ã¾ã§ã§ã™ï¼", "error", 2000);
      return;
    }
    
    const char = base[selectedMyChar];
    const message = document.getElementById("tradeMessage").value;
    db.ref("publicTrades").push({
      owner: playerId, 
      ownerCharIndex: selectedMyChar, 
      ownerCharData: JSON.stringify(char), 
      ownerCharName: getCharName(char), 
      message: message, 
      status: "open", 
      timestamp: Date.now()
    });
    showToast("âœ… ã‚­ãƒ£ãƒ©ã‚’å‡ºå“ã—ã¾ã—ãŸï¼", "success");
    document.getElementById("tradeMessage").value = "";
    selectedMyChar = null;
    renderMyCharList();
  });
}

function renderIncomingRequests(){
  const container = document.getElementById("incomingRequests");
  container.innerHTML = "";
  
  db.ref("publicTrades").once("value").then(snap=>{
    const trades = snap.val();
    if(!trades) return;
    
    let foundIncoming = false;
    let foundWaiting = false;
    
    const incomingDiv = document.createElement("div");
    incomingDiv.innerHTML = "<h5 style='color:#4CAF50; margin:10px 0 5px 0;'>ğŸ“¥ å—ã‘å–ã£ãŸç”³è«‹</h5>";
    
    Object.entries(trades).forEach(([id, trade])=>{
      if(trade.status !== "waiting" || trade.owner !== playerId) return;
      foundIncoming = true;
      const div = document.createElement("div");
      div.className = "tradeOffer pending";
      const applicantChar = JSON.parse(trade.applicantCharData);
      div.innerHTML = `<div><strong>ğŸ“© ${trade.applicantId}</strong> ãŒç”³è«‹</div><div style="font-size:12px; margin:5px 0;">ğŸ“¦ æ±‚ã‚ã‚‹: <strong>${trade.ownerCharName}</strong></div><div style="font-size:12px; margin:5px 0;">ğŸ æä¾›: <strong>${getCharName(applicantChar)}</strong></div><div style="font-size:11px; margin:5px 0;">ğŸ’¬ ${trade.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>`;
      
      const btnDiv = document.createElement("div");
      btnDiv.style.marginTop = "8px";
      btnDiv.style.display = "flex";
      btnDiv.style.gap = "5px";
      
      const acceptBtn = document.createElement("button");
      acceptBtn.textContent = "âœ… æ‰¿èª";
      acceptBtn.style.flex = "1";
      acceptBtn.style.fontSize = "11px";
      acceptBtn.style.padding = "5px";
      acceptBtn.style.background = "#4CAF50";
      acceptBtn.onclick = ()=>{ acceptTradeRequest(id, trade); };
      
      const rejectBtn = document.createElement("button");
      rejectBtn.textContent = "âŒ æ‹’å¦";
      rejectBtn.style.flex = "1";
      rejectBtn.style.fontSize = "11px";
      rejectBtn.style.padding = "5px";
      rejectBtn.style.background = "#d32f2f";
      rejectBtn.onclick = ()=>{ rejectTradeRequest(id); };
      
      btnDiv.appendChild(acceptBtn);
      btnDiv.appendChild(rejectBtn);
      div.appendChild(btnDiv);
      incomingDiv.appendChild(div);
    });
    
    if(foundIncoming) container.appendChild(incomingDiv);
    
    const waitingDiv = document.createElement("div");
    waitingDiv.innerHTML = "<h5 style='color:#2196F3; margin:10px 0 5px 0;'>â³ æ‰¿èªå¾…ã¡</h5>";
    
    Object.entries(trades).forEach(([id, trade])=>{
      if(trade.status !== "waiting" || trade.applicantId !== playerId) return;
      foundWaiting = true;
      const div = document.createElement("div");
      div.className = "tradeOffer waiting";
      const ownerChar = JSON.parse(trade.ownerCharData);
      div.innerHTML = `<div><strong>â³ ${trade.owner}</strong> ã®æ‰¿èªå¾…ã¡</div><div style="font-size:12px; margin:5px 0;">ğŸ“¦ å¸Œæœ›: <strong>${trade.ownerCharName}</strong></div><div style="font-size:12px; margin:5px 0;">ğŸ æä¾›: <strong>${getCharName(JSON.parse(trade.applicantCharData))}</strong></div><div style="font-size:11px; margin:5px 0;">ğŸ’¬ ${trade.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>`;
      
      const btnDiv = document.createElement("div");
      btnDiv.style.marginTop = "8px";
      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "âŒ ç”³è«‹ã‚’å–ã‚Šæ¶ˆã™";
      cancelBtn.style.width = "100%";
      cancelBtn.style.fontSize = "11px";
      cancelBtn.style.padding = "5px";
      cancelBtn.style.background = "#d32f2f";
      cancelBtn.onclick = ()=>{ cancelTradeRequest(id); };
      btnDiv.appendChild(cancelBtn);
      div.appendChild(btnDiv);
      waitingDiv.appendChild(div);
    });
    
    if(foundWaiting) container.appendChild(waitingDiv);
    
    if(!foundIncoming && !foundWaiting){
      container.innerHTML = "<div style='text-align:center; padding:10px; color:#999;'>ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>";
    }
  });
}

function acceptTradeRequest(tradeId, trade){
  const myChar = base[trade.ownerCharIndex];
  const theirChar = JSON.parse(trade.applicantCharData);
  if(!myChar){ showNotification("âŒ ã‚­ãƒ£ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error", 2000); return; }
  
  base[trade.ownerCharIndex] = theirChar;
  
  db.ref("publicTrades/" + tradeId).update({status: "completed", ownerApproved: true});
  
  renderBase();
  saveGame();
  
  showToast("âœ… äº¤æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼", "success");
  renderIncomingRequests();
}

function rejectTradeRequest(tradeId){
  showDialog("ç”³è«‹ã‚’æ‹’å¦", "ã“ã®ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿ", (confirmed) => {
    if(confirmed){
      db.ref("publicTrades/" + tradeId).remove();
      showToast("âŒ ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã—ãŸ", "info");
      renderIncomingRequests();
    }
  });
}

function cancelTradeRequest(tradeId){
  showDialog("ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—", "ã“ã®ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ", (confirmed) => {
    if(confirmed){
      db.ref("publicTrades/" + tradeId).remove();
      showToast("âœ… ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ", "success");
      renderIncomingRequests();
    }
  });
}

function renderPublicTrades(){
  const container = document.getElementById("publicTradesList");
  container.innerHTML = "èª­ã¿è¾¼ã¿ä¸­...";
  db.ref("publicTrades").once("value").then(snap=>{
    const trades = snap.val();
    container.innerHTML = "";
    if(!trades){ container.innerHTML = "<div style='text-align:center; padding:10px; color:#999;'>å‹Ÿé›†ãŒã‚ã‚Šã¾ã›ã‚“</div>"; return; }
    let found = false;
    Object.entries(trades).forEach(([id, trade])=>{
      if(trade.status !== "open" || trade.owner === playerId) return;
      found = true;
      const div = document.createElement("div");
      div.className = "tradeOffer";
      const ownerChar = JSON.parse(trade.ownerCharData);
      div.innerHTML = `<div><strong>ğŸ“¤ ${trade.owner}</strong></div><div style="font-size:12px; margin:5px 0;">ğŸ“¦ å‹Ÿé›†: <strong>${getCharName(ownerChar)}</strong></div><div style="font-size:11px; margin:5px 0;">ğŸ’¬ ${trade.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>`;
      const selectDiv = document.createElement("div");
      selectDiv.style.marginTop = "8px";
      selectDiv.innerHTML = "<div style='font-size:11px; margin-bottom:5px;'>äº¤æ›ã™ã‚‹ã‚­ãƒ£ãƒ©:</div>";
      base.forEach((c, idx)=>{
        if(!c) return;
        const btn = document.createElement("button");
        btn.textContent = `[${idx}] ${getCharName(c)}`;
        btn.style.width = "100%";
        btn.style.marginTop = "3px";
        btn.style.fontSize = "11px";
        btn.style.padding = "5px";
        btn.onclick = ()=>{ applyTrade(id, trade, idx); };
        selectDiv.appendChild(btn);
      });
      div.appendChild(selectDiv);
      container.appendChild(div);
    });
    if(!found) container.innerHTML = "<div style='text-align:center; padding:10px; color:#999;'>å‹Ÿé›†ãŒã‚ã‚Šã¾ã›ã‚“</div>";
  });
}

function applyTrade(tradeId, trade, myCharIdx){
  const myChar = base[myCharIdx];
  if(!myChar){ showNotification("âŒ ã‚­ãƒ£ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error", 2000); return; }
  
  db.ref("publicTrades/" + tradeId).update({
    status: "waiting",
    applicantId: playerId,
    applicantCharIndex: myCharIdx,
    applicantCharData: JSON.stringify(myChar)
  });
  
  showToast("âœ… äº¤æ›ç”³è«‹ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼æ‰¿èªå¾…ã¡ã§ã™...", "success");
  switchTradeTab("offer");
  renderIncomingRequests();
}

const adminPanel = document.getElementById("adminPanel");
let isDragging = false, offsetX, offsetY;
adminPanel.addEventListener("mousedown", (e)=>{ isDragging = true; offsetX = e.clientX - adminPanel.offsetLeft; offsetY = e.clientY - adminPanel.offsetTop; adminPanel.style.right = "auto"; });
document.addEventListener("mousemove", (e)=>{ if(!isDragging) return; adminPanel.style.left = (e.clientX - offsetX) + "px"; adminPanel.style.top = (e.clientY - offsetY) + "px"; });
document.addEventListener("mouseup", ()=>{ isDragging = false; });

setInterval(()=>{ let income = base.filter(c=>c).reduce((sum,c)=>sum+c.rate,0); money += income * incomeMultiplier; updateUI(); },1000);

function saveGame(){
  db.ref("players/" + playerId).set({money, baseLevel, capacity, incomeMultiplier, base, fuseList, lastSave: Date.now()});
}

setInterval(saveGame, 10000);

function loadGame(){
  db.ref("players/" + playerId).once("value").then(snapshot=>{
    const data = snapshot.val();
    if(!data) return;
    money = data.money || 0;
    baseLevel = data.baseLevel || 1;
    capacity = data.capacity || 10;
    incomeMultiplier = data.incomeMultiplier || 1;
    base = data.base || [];
    fuseList = data.fuseList || [];
    ensureBaseSlots();
    renderBase();
    renderFuse();
    updateUI();
  });
}

function startSpawn(){ spawnInterval=setInterval(spawnWalker,3000); }
function stopSpawn(){ clearInterval(spawnInterval); }
document.addEventListener("visibilitychange",()=>{ document.hidden ? stopSpawn() : startSpawn(); });

loadGame();
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
db.ref("globalEvent").on("value", snap => {
  const data = snap.val();

  if(!data || !data.active){
    adminEventActive = false;
    document.getElementById("adminEventBanner").style.display = "none";
    clearInterval(eventCountdownInterval);
    return;
  }

  adminEventActive = true;
  globalLuckMultiplier = data.luck || 1;
  document.getElementById("adminEventBanner").style.display = "block";

  const endTime = data.endTime;

  clearInterval(eventCountdownInterval);

  eventCountdownInterval = setInterval(()=>{
    const remain = endTime - Date.now();

    if(remain <= 0){
      clearInterval(eventCountdownInterval);
      document.getElementById("adminEventTime").innerText = "çµ‚äº†";
      return;
    }

    const minutes = Math.floor(remain / 60000);
    const seconds = Math.floor((remain % 60000) / 1000);

    document.getElementById("adminEventTime").innerText =
      minutes.toString().padStart(2,"0") + ":" +
      seconds.toString().padStart(2,"0");

  },1000);
});
ensureBaseSlots();
renderBase();
startSpawn();
updateUI();

db.ref("globalEvent").on("value", snapshot=>{
  const data = snapshot.val();
  const eventStatus = document.getElementById("eventStatus");
  const banner = document.getElementById("adminEventBanner");
  
  if(data && data.active){
    adminEventActive = true;
    globalLuckMultiplier = data.luck;
    banner.style.display="block";
    
    clearInterval(eventCountdownInterval);
    eventCountdownInterval = setInterval(()=>{
      const now = Date.now();
      const timeLeft = data.endTime - now;
      
      if(timeLeft <= 0){
        adminEventActive = false;
        globalLuckMultiplier = 1;
        banner.style.display="none";
        eventStatus.innerText = "ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­";
        clearInterval(eventCountdownInterval);
        db.ref("globalEvent").set({active:false});
        showToast("â° ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ", "info");
      } else {
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        eventStatus.innerHTML = `ğŸ”¥ ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ä¸­<br>â° ${minutes}åˆ†${seconds}ç§’`;
      }
    }, 1000);
    
  } else {
    adminEventActive = false;
    globalLuckMultiplier = 1;
    banner.style.display="none";
    eventStatus.innerText="ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­";
    clearInterval(eventCountdownInterval);
  }
});
</script>

</body>
</html>
