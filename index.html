<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>kiichibrainrot</title>
<meta name="google-site-verification" content="google1c7a1b08f6e97eca.html" />
<meta name="description" content="kiichiãŒã¤ãã£ãŸãƒ–ãƒ¬ãƒ­ãƒãƒƒãƒ—ã§ã™ã€‚">
<meta name="keywords" content="brainrot,kiichibrainrot,KiichiBrainrot">
<style>
/* æ—¢å­˜ walker ç”¨ */
.walker{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:120px;
  padding:8px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  animation: float 1s ease-in-out infinite alternate;
}

@keyframes float {
  0% { transform: translateX(-50%) translateY(0px); }
  50% { transform: translateX(-50%) translateY(3px); }
  100% { transform: translateX(-50%) translateY(0px); }
}

@keyframes glowBlink {
  0%, 100% { box-shadow: 0 0 10px magenta, 0 0 20px orange, 0 0 30px aqua; }
  50% { box-shadow: 0 0 20px magenta, 0 0 40px orange, 0 0 60px aqua; }
}

.glow {
  animation: float 1s ease-in-out infinite alternate, glowBlink 0.8s ease-in-out infinite alternate;
}

body{
  margin:0;
  background:#111;
  color:white;
  font-family:sans-serif;
  overflow:hidden;
}

#ui{
  position:absolute;
  top:10px;
  left:10px;
  z-index:10;
  max-width:300px;
  max-height:180px;
  overflow-y:auto;
}

#ui h3 {
  display:none;
}

#ui div {
  font-size:12px;
  margin:2px 0;
}

#carpet{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:200px;
  height:2000px;
  background:linear-gradient(#700,#900);
}

#base{
  position:absolute;
  left:0;
  bottom:0;
  width:calc(45% - 80px);
  height:300px;
  border-top:3px solid cyan;
  border-right:3px solid cyan;
  padding:10px;
  box-sizing:border-box;
  overflow-y:auto;
  display:grid;
  grid-template-columns:repeat(auto-fill, 110px);
  gap:5px;
  background:#0a0f1a;
}

.char, .walker{
  width:100px;
  height:80px;
  padding:6px;
  font-size:12px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
  cursor:pointer;
  box-sizing:border-box;
}

.walker{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  animation: float 1s ease-in-out infinite alternate;
}

button{cursor:pointer;}

.char div, .walker div{
  line-height:1.1;
}

.char{
  position:relative;
}

#notificationPanel {
  position:fixed;
  bottom:20px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,0.95);
  color:white;
  padding:20px 30px;
  border-radius:15px;
  border:2px solid #4CAF50;
  box-shadow:0 0 30px rgba(76,175,80,0.5);
  z-index:5000;
  display:none;
  text-align:center;
  font-size:16px;
  font-weight:bold;
  max-width:400px;
}

#tradePanel{
  position:fixed;
  top:20px;
  right:20px;
  width:380px;
  max-height:650px;
  background:#1e1e1e;
  color:white;
  padding:15px;
  border-radius:15px;
  box-shadow:0 0 25px black;
  overflow-y:auto;
  z-index:3000;
  display:none;
  border:2px solid #4CAF50;
}

#tradePanel h3{
  margin-top:0;
  color:#4CAF50;
}

#tradePanel input{
  position:fixed;
  width:100%;
  padding:8px;
  margin:5px 0;
  box-sizing:border-box;
  border-radius:5px;
  border:1px solid #666;
  background:#222;
  color:white;
}

.tradeCharItem{
  padding:8px;
  margin:5px 0;
  border:1px solid #555;
  border-radius:5px;
  cursor:pointer;
  background:#222;
}

.tradeCharItem.selected{
  background:#4CAF50;
  color:black;
}

.tradeList{
  max-height:300px;
  overflow-y:auto;
  border:1px solid #555;
  border-radius:5px;
  padding:8px;
  margin:10px 0;
}

.tradeOffer{
  padding:10px;
  margin:8px 0;
  border:1px solid #888;
  border-radius:5px;
  background:#222;
}

.tradeOffer.pending{
  border-color:#ff9800;
  background:#2a2000;
}

.tradeOffer.waiting{
  border-color:#2196F3;
  background:#002a3a;
}

#fuseArea{
  position:fixed;
  bottom:20px;
  right:20px;
  width:300px;
  max-height:650px;
  border:4px solid #2196F3;
  background:#1e1e1e;
  display:none;
  flex-direction:column;
  padding:15px;
  border-radius:15px;
  z-index:3000;
  box-shadow:0 0 25px black;
}

#fuseArea h3{
  margin-top:0;
  color:#2196F3;
}

#fuseSlots{
  flex:1;
  overflow-y:auto;
  max-height:400px;
}

#tradeToggleBtn{
  position:fixed;
  top:15px;
  right:20px;
  padding:12px 18px;
  background:#4CAF50;
  color:white;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  z-index:2000;
}

#fuseToggleBtn{
  position:fixed;
  bottom:15px;
  right:20px;
  padding:12px 18px;
  background:#2196F3;
  color:white;
  border:none;
  border-radius:12px;
  font-weight:bold;
  cursor:pointer;
  z-index:2000;
}

#adminPanel{
  display:none;
  position:absolute;
  right:5px;
  top:120px;
  width:260px;
  background:#111;
  border:3px solid gold;
  padding:15px;
  z-index:1000;
  cursor:move;
}

#adminPanel button{
  width:100%;
  margin:5px 0;
  padding:8px;
}

#adminEventBanner{
  display:none;
  position:fixed;
  right:20px;
  bottom:80px;
  background:linear-gradient(45deg,gold,orange);
  color:black;
  font-weight:bold;
  padding:12px 20px;
  border-radius:10px;
  box-shadow:0 0 15px gold;
  z-index:2000;
  animation:pulse 1s infinite alternate;
}

@keyframes pulse{
  from { transform:scale(1); box-shadow:0 0 10px gold; }
  to { transform:scale(1.08); box-shadow:0 0 25px orange; }
}

#codeBox{
  margin:10px;
}

#codeBox input{
  padding:5px;
  border-radius:5px;
  border:1px solid #666;
  background:#222;
  color:white;
  width:150px;
}

#codeBox button{
  padding:5px 10px;
  margin:0 5px;
}

button{
  background:#444;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:5px;
  cursor:pointer;
  font-weight:bold;
}

button:hover{
  background:#666;
}

.toast {
  position:fixed;
  bottom:100px;
  right:20px;
  background:rgba(0,0,0,0.9);
  color:white;
  padding:15px 20px;
  border-radius:10px;
  border-left:4px solid #4CAF50;
  z-index:4999;
  animation: slideIn 0.4s ease-out;
  max-width:300px;
}

@keyframes slideIn {
  from { transform: translateX(100%); opacity:0; }
  to { transform: translateX(0); opacity:1; }
}

#dialogBackdrop {
  position:fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  background:rgba(0,0,0,0.7);
  z-index:4998;
  display:none;
}

#dialogBox {
  position:fixed;
  left:50%;
  top:50%;
  transform:translate(-50%, -50%);
  background:#1e1e1e;
  padding:30px;
  border-radius:15px;
  border:2px solid #4CAF50;
  box-shadow:0 0 30px rgba(76,175,80,0.5);
  z-index:4999;
  display:none;
  max-width:400px;
  text-align:center;
  color:white;
}

#dialogBox.show {
  display:block;
}

#dialogBox h3 {
  margin-top:0;
  color:#4CAF50;
  font-size:24px;
}

#dialogBox .buttons {
  margin-top:20px;
  display:flex;
  gap:10px;
}

#dialogBox button {
  flex:1;
  padding:10px;
}

#dialogBox button.confirm {
  background:#4CAF50;
}

#dialogBox button.cancel {
  background:#666;
}
</style>
</head>
<body>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCs4uhyRzBC8nSJrwWrd_fBdzIJjR7D3A0",
  authDomain: "brainrot-3e022.firebaseapp.com",
  databaseURL: "https://brainrot-3e022-default-rtdb.firebaseio.com",
  projectId: "brainrot-3e022",
  storageBucket: "brainrot-3e022.firebasestorage.app",
  messagingSenderId: "489333416512",
  appId: "1:489333416512:web:1652e3f5cb8d3801ee75a5",
  measurementId: "G-HCFMTTL0WV"
};
firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
<div id="globalNoticeBox"
     style="
       position:absolute;
       top:10px;
       right:61%;
       width:260px;
       min-height:80px;
       background:#111;
       border:2px solid gold;
       border-radius:10px;
       padding:10px;
       z-index:1500;
     ">
  <div style="font-weight:bold; color:gold;">é‹å–¶ã‹ã‚‰ã®ãŠçŸ¥ã‚‰ã›</div>
  <div id="globalNoticeText" style="margin-top:5px; font-size:13px;">
    ç¾åœ¨ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“
  </div>
</div>

<div id="ui">
  <div>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ <span id="money">0</span></div>
  <div>ãƒªãƒãƒ¼ã‚¹ <span id="level">1</span></div>
  <div>å®¹é‡ <span id="cap">10</span></div>
  <div>å€ç‡ x<span id="multiplier">1</span></div>
  <button id="upgradeBtn" onclick="upgradeBase()" style="width:100%; margin-top:8px;">ãƒªãƒãƒ¼ã‚¹</button>
  <button onclick="showResetDialog()" style="background:#d32f2f; width:100%; margin-top:3px;">ãƒªã‚»ãƒƒãƒˆ</button>
  <hr>
  <div id="codeBox">
    <button onclick="openCodePrompt()">ã‚³ãƒ¼ãƒ‰</button>
  </div>
</div>

<div id="adminPanel">
  <h3 style="color:gold;">ğŸ‘‘ ç®¡ç†è€…ãƒ‘ãƒãƒ«</h3>

  <button onclick="addMoney(1000000000)" style="background:#4CAF50;">ğŸ’° +1B</button>
  <button onclick="addMoney(100000000000)" style="background:#4CAF50;">ğŸ’° +100B</button>
  <button onclick="addMoney(1000000000000)" style="background:#4CAF50;">ğŸ’° +1T</button>

  <hr>

  <button onclick="startAdminEvent()" style="background:#ff9800;">ğŸ‰ ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹</button>
  <button onclick="stopAdminEvent()" style="background:#d32f2f;">ğŸ›‘ ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†</button>

  <hr>
<h4>ğŸ“¢ å…¨ä½“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡</h4>
<input type="text" id="adminNoticeInput" placeholder="ä¾‹ï¼šæœ¬æ—¥20:00ã€œã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬">
<button onclick="sendGlobalNotice()" style="background:gold; color:black;">
é€ä¿¡
</button>
<button onclick="clearGlobalNotice()" style="background:#555;">
å‰Šé™¤
</button>
  <hr>

  <button onclick="closeAdminPanel()" style="background:#555;">âŒ é–‰ã˜ã‚‹</button>

  </div>

<div id="carpet"></div>
<div id="reverseRequirementDisplay"
     style="
       position:absolute;
       bottom:310px;
       left:10px;
       background:#000;
       padding:10px 15px;
       border:2px solid gold;
       border-radius:10px;
       font-weight:bold;
       z-index:100;
     ">
</div>
<div id="base"></div>

<button id="tradeToggleBtn" onclick="toggleTradePanel()">ğŸ”„ ã‚­ãƒ£ãƒ©äº¤æ›</button>
<button id="fuseToggleBtn" onclick="toggleFusePanel()">ğŸ§ª åˆæˆ</button>

<div id="tradePanel">
  <h3>ğŸŒ ã‚­ãƒ£ãƒ©äº¤æ›</h3>
  <button onclick="toggleTradePanel()" 
style="
position:absolute;
top:10px;
right:10px;
background:#d32f2f;
padding:6px 10px;
border-radius:8px;
">
âœ•
</button>
  <div style="display:flex; gap:5px; margin-bottom:10px;">
    <button onclick="switchTradeTab('offer')" id="tabOffer" style="flex:1; background:#4CAF50;">ğŸ“¤ å‡ºå“</button>
    <button onclick="switchTradeTab('find')" id="tabFind" style="flex:1; background:#666;">ğŸ” å‹Ÿé›†</button>
  </div>
  <div id="offerTab">
    <h4>è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‹ã‚‰é¸æŠ</h4>
    <div class="tradeList" id="myCharList"></div>
    <label>å‹Ÿé›†èª¬æ˜:</label>
    <input type="text" id="tradeMessage" placeholder="ä¾‹ï¼šã‚¤ãƒ™ãƒ‰ãƒ©å¸Œæœ›">
    <button onclick="postTrade()" style="width:100%; background:#4CAF50;">ğŸ“¤ å‡ºå“ã™ã‚‹</button>
    <hr>
    <h4>äº¤æ›ç”³è«‹</h4>
    <div class="tradeList" id="incomingRequests"></div>
  </div>
  <div id="findTab" style="display:none;">
    <h4>å‹Ÿé›†ä¸­ã®äº¤æ›</h4>
    <div class="tradeList" id="publicTradesList"></div>
  </div>
  
</div>

<div id="fuseArea">
  <h3>ğŸ§ª ãƒã‚·ãƒ¼ãƒ³</h3>
  <div>åˆè¨ˆåç›Š: <span id="fuseTotal">0</span>/s</div>
  <div id="fuseSlots"></div>
  <button onclick="fuse()" style="width:100%; background:#2196F3; margin-top:8px;">åˆæˆ</button>
  <button onclick="toggleFusePanel()" style="width:100%; margin-top:5px; background:#d32f2f;">âœ• é–‰ã˜ã‚‹</button>
</div>

<div id="adminEventBanner">
  ğŸ‘‘ ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆç™ºå‹•ä¸­<br>
  â³ æ®‹ã‚Šæ™‚é–“: <span id="adminEventTime">--:--</span>
</div>
<div id="notificationPanel"></div>
<div id="dialogBackdrop"></div>
<div id="dialogBox">
  <h3 id="dialogTitle">ç¢ºèª</h3>
  <p id="dialogMessage"></p>
  <div class="buttons">
    <button class="confirm" onclick="confirmDialog()">ã¯ã„</button>
    <button class="cancel" onclick="cancelDialog()">ã„ã„ãˆ</button>
  </div>
</div>

<script>
let playerId = localStorage.getItem("playerId");
if(!playerId){
  playerId = "player_" + Math.random().toString(36).substr(2,9);
  localStorage.setItem("playerId", playerId);
}

let adminEventActive = false, globalLuckMultiplier = 1, isAdmin = false;
let usedCodes = JSON.parse(localStorage.getItem("usedCodes")||"[]");
let selectedMyChar = null, currentTradeTab = "offer", dialogCallback = null;
let selectedForFusion = [];
let eventCountdownInterval = null;
function sendGlobalNotice(){
  if(!isAdmin) return;

  const text = document.getElementById("adminNoticeInput").value;
  if(!text){
    showToast("âš  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„", "error");
    return;
  }

  db.ref("globalNotice").set({
    message: text,
    timestamp: Date.now()
  });

  showToast("ğŸ“¢ å…¨ä½“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡ã—ã¾ã—ãŸ", "success");
}
function clearGlobalNotice(){
  if(!isAdmin) return;

  db.ref("globalNotice").remove();
  showToast("ğŸ—‘ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "info");
}

const rarities = [
  {name:"COMMON", color:"#777", rate:1000, chance:49},
  {name:"RARE", color:"blue", rate:5000, chance:26},
  {name:"EPIC", color:"purple", rate:20000, chance:14},
  {name:"LEGENDARY", color:"gold", rate:80000, chance:7},
  {name:"MYTHIC", color:"orange", rate:200000, chance:3},
  {name:"GOD", color:"rainbow", rate:1000000, chance:0.9},
  {name:"SECRET", color:"black", rate:0, chance:0.1}
];

const attributes = [
  {name:"Default", multiplier:1, chance:84.2, color:"#444"},
  {name:"Gold", multiplier:1.5, chance:5, color:"gold"},
  {name:"Diamond", multiplier:3, chance:3, color:"cyan"},
  {name:"Galaxy", multiplier:5, chance:2, color:"magenta"},
  {name:"Dreamy", multiplier:7, chance:1.5, color:"pink"},
  {name:"Lava", multiplier:8, chance:1, color:"red"},
  {name:"Aqua", multiplier:9, chance:0.8, color:"blue"},
  {name:"Rainbow", multiplier:10, chance:0.6, color:"orange"},
  {name:"Netherite", multiplier:10, chance:0.6, color:"gray"},
  {name:"Amethyst", multiplier:10.5, chance:0.5, color:"purple"},
  {name:"Toxic", multiplier:11, chance:0.4, color:"lime"},
  {name:"Ultimate", multiplier:12, chance:0.25, color:"white"},
  {name:"Void", multiplier:13, chance:0.15, color:"black"}
];

const mutations = [
  {name:"Lightning", bonus:2, icon:"âš¡"},
  {name:"Ice", bonus:2, icon:"ğŸ§Š"},
  {name:"Nether", bonus:2.5, icon:"ğŸ”¥"},
  {name:"End", bonus:3, icon:"ğŸŒŒ"},
  {name:"Enchant", bonus:3, icon:"âœ¨"},
  {name:"Inmu", bonus:4, icon:"â˜ "}
];

const secretCharacters = [
  {character:"Piccione Macchina", rate:500000},{character:"Pakrahmatmamat", rate:600000},{character:"Orcalero Orcala", rate:1000000},{character:"Pot Hotspot", rate:2000000},{character:"Nooo My Hotspot", rate:2500000},{character:"Garamaramadungdung", rate:3000000},{character:"Il Sacro Cabrospaghetti", rate:4000000},{character:"La Grande Combinacion", rate:5000000},{character:"Yess My Hotspot", rate:5500000},{character:"67", rate:6700000},{character:"69", rate:13800000},{character:"Ketupat Kepat Prekupat", rate:10000000},{character:"Nooo My Bicicleteira", rate:13500000},{character:"W or L", rate:13000000},{character:"Lirili Ralilu", rate:17000000},{character:"La Esok Sekolah", rate:20000000},{character:"La Sercret Combinacion", rate:27000000},{character:"Chimpanzini Kingini", rate:25000000},{character:"Strawberry Elephant", rate:30000000},{character:"Klombo", rate:32000000},{character:"Gorgonzilla", rate:57000000},{character:"Lobterila Keriktos", rate:42000000},{character:"Spaghetti Tualetti", rate:40000000},{character:"Cannelloni Dragoni", rate:50000000},{character:"La Crazy Combinacion", rate:60000000},{character:"Chocone Dragone", rate:80000000},{character:"Gigalitraktos Spidorobos", rate:75000000},{character:"Tiramisubmarini", rate:90000000},{character:"Garbagzilla", rate:100000000},{character:"Cannone Maledettone", rate:115000000},{character:"SKIBIDI TOILET", rate:350000000},{character:"YAJUU SENPAI", rate:810000000},{character:"KOU CHOU", rate:1266000000}
];

const reverseRequirements = {
  2: "COMMON",
  3: "RARE",
  4: "EPIC",
  5: "LEGENDARY",
  6: "MYTHIC",
  7: "GOD",
  8: "Orcalero Orcala",
  9: "Pot Hotspot",
  10: "Garamaramadungdung",
  11: "La Grande Combinacion",
  12: "67",
  13: "69",
  14: "Lirili Ralilu",
  15: "La Esok Sekolah",
  16: "La Sercret Combinacion",
  17: "Strawberry Elephant",
  18: "Spaghetti Tualetti",
  19: "Cannelloni Dragoni",
  20: "La Crazy Combinacion",
  21: "Gigalitraktos Spidorobos",
  22: "Tiramisubmarini",
  23: "Cannone Maledettone",
  24: "SKIBIDI TOILET",
  25: "YAJUU SENPAI",
};

const fuseTable = [

{min:0, max:10000, results:[
  {type:"rarity", value:"COMMON", chance:65},
  {type:"rarity", value:"RARE", chance:25},
  {type:"rarity", value:"EPIC", chance:10}
]},

{min:10000, max:30000, results:[
  {type:"rarity", value:"COMMON", chance:25},
  {type:"rarity", value:"RARE", chance:35},
  {type:"rarity", value:"EPIC", chance:30},
  {type:"rarity", value:"LEGENDARY", chance:10}
]},

{min:30000, max:50000, results:[
  {type:"rarity", value:"RARE", chance:30},
  {type:"rarity", value:"EPIC", chance:35},
  {type:"rarity", value:"LEGENDARY", chance:30},
  {type:"rarity", value:"MYTHIC", chance:5}
]},

{min:50000, max:100000, results:[
  {type:"rarity", value:"RARE", chance:30},
  {type:"rarity", value:"EPIC", chance:35},
  {type:"rarity", value:"LEGENDARY", chance:20},
  {type:"rarity", value:"MYTHIC", chance:15}
]},

{min:100000, max:250000, results:[
  {type:"rarity", value:"EPIC", chance:30},
  {type:"rarity", value:"LEGENDARY", chance:40},
  {type:"rarity", value:"MYTHIC", chance:25},
  {type:"rarity", value:"GOD", chance:5}
]},

{min:250000, max:500000, results:[
  {type:"rarity", value:"EPIC", chance:20},
  {type:"rarity", value:"LEGENDARY", chance:30},
  {type:"rarity", value:"MYTHIC", chance:25},
  {type:"rarity", value:"GOD", chance:25}
]},

{min:500000, max:1000000, results:[
  {type:"rarity", value:"LEGENDARY", chance:25},
  {type:"rarity", value:"MYTHIC", chance:35},
  {type:"rarity", value:"GOD", chance:30},
  {type:"secret", value:"Orcalero Orcala", chance:10}
]},

{min:1000000, max:1500000, results:[
  {type:"rarity", value:"LEGENDARY", chance:15},
  {type:"rarity", value:"MYTHIC", chance:30},
  {type:"rarity", value:"GOD", chance:35},
  {type:"secret", value:"Orcalero Orcala", chance:15},
  {type:"secret", value:"Pot Hotspot", chance:5}
]},

{min:1500000, max:3000000, results:[
  {type:"rarity", value:"MYTHIC", chance:30},
  {type:"rarity", value:"GOD", chance:35},
  {type:"secret", value:"Orcalero Orcala", chance:15},
  {type:"secret", value:"Pot Hotspot", chance:15},
  {type:"secret", value:"Garamaramadungdung", chance:5}
]},

{min:3000000, max:5000000, results:[
  {type:"rarity", value:"GOD", chance:30},
  {type:"secret", value:"Orcalero Orcala", chance:30},
  {type:"secret", value:"Pot Hotspot", chance:20},
  {type:"secret", value:"Garamaramadungdung", chance:10},
  {type:"secret", value:"La Grande Combinacion", chance:10}
]},

{min:5000000, max:8000000, results:[
  {type:"secret", value:"Pot Hotspot", chance:35},
  {type:"secret", value:"Garamaramadungdung", chance:25},
  {type:"secret", value:"La Grande Combinacion", chance:20},
  {type:"secret", value:"67", chance:20}
]},

{min:8000000, max:12000000, results:[
  {type:"secret", value:"Garamaramadungdung", chance:25},
  {type:"secret", value:"La Grande Combinacion", chance:30},
  {type:"secret", value:"67", chance:20},
  {type:"secret", value:"69", chance:15},
  {type:"secret", value:"Lirili Ralilu", chance:10}
]},

{min:12000000, max:15000000, results:[
  {type:"secret", value:"67", chance:35},
  {type:"secret", value:"69", chance:35},
  {type:"secret", value:"Lirili Ralilu", chance:25},
  {type:"secret", value:"La Esok Sekolah", chance:5}
]},

{min:15000000, max:20000000, results:[
  {type:"secret", value:"67", chance:15},
  {type:"secret", value:"69", chance:30},
  {type:"secret", value:"Lirili Ralilu", chance:30},
  {type:"secret", value:"La Esok Sekolah", chance:20},
  {type:"secret", value:"La Sercret Combinacion", chance:5}
]},

{min:20000000, max:25000000, results:[
  {type:"secret", value:"69", chance:25},
  {type:"secret", value:"Lirili Ralilu", chance:30},
  {type:"secret", value:"La Esok Sekolah", chance:30},
  {type:"secret", value:"La Sercret Combinacion", chance:15}
]},

{min:25000000, max:30000000, results:[
  {type:"secret", value:"Lirili Ralilu", chance:30},
  {type:"secret", value:"La Esok Sekolah", chance:35},
  {type:"secret", value:"La Sercret Combinacion", chance:20},
  {type:"secret", value:"Chimpanzini Kingini", chance:10},
  {type:"secret", value:"Spaghetti Tualetti", chance:5}
]},

{min:30000000, max:35000000, results:[
  {type:"secret", value:"La Esok Sekolah", chance:30},
  {type:"secret", value:"La Sercret Combinacion", chance:25},
  {type:"secret", value:"Chimpanzini Kingini", chance:20},
  {type:"secret", value:"Spaghetti Tualetti", chance:20},
  {type:"secret", value:"Gorgonzilla", chance:5}
]},

{min:35000000, max:40000000, results:[
  {type:"secret", value:"La Sercret Combinacion", chance:35},
  {type:"secret", value:"Chimpanzini Kingini", chance:35},
  {type:"secret", value:"Spaghetti Tualetti", chance:25},
  {type:"secret", value:"Gorgonzilla", chance:5}
]},

{min:40000000, max:50000000, results:[
  {type:"secret", value:"La Sercret Combinacion", chance:20},
  {type:"secret", value:"Chimpanzini Kingini", chance:35},
  {type:"secret", value:"Spaghetti Tualetti", chance:30},
  {type:"secret", value:"Gorgonzilla", chance:15}
]},

{min:50000000, max:65000000, results:[
  {type:"secret", value:"Chimpanzini Kingini", chance:40},
  {type:"secret", value:"Spaghetti Tualetti", chance:45},
  {type:"secret", value:"Gorgonzilla", chance:10},
  {type:"secret", value:"La Crazy Combinacion", chance:5}
]},

{min:65000000, max:80000000, results:[
  {type:"secret", value:"Spaghetti Tualetti", chance:45},
  {type:"secret", value:"Gorgonzilla", chance:35},
  {type:"secret", value:"La Crazy Combinacion", chance:15},
  {type:"secret", value:"Gigalitraktos Spidorobos", chance:5}
]},

{min:80000000, max:100000000, results:[
  {type:"secret", value:"Spaghetti Tualetti", chance:30},
  {type:"secret", value:"Gorgonzilla", chance:35},
  {type:"secret", value:"La Crazy Combinacion", chance:20},
  {type:"secret", value:"Gigalitraktos Spidorobos", chance:10},
  {type:"secret", value:"Tiramisubmarini", chance:5}
]},

{min:100000000, max:160000000, results:[
  {type:"secret", value:"Gorgonzilla", chance:35},
  {type:"secret", value:"La Crazy Combinacion", chance:35},
  {type:"secret", value:"Gigalitraktos Spidorobos", chance:15},
  {type:"secret", value:"Tiramisubmarini", chance:15}
]},

{min:160000000, max:Infinity, results:[
  {type:"secret", value:"Gorgonzilla", chance:25},
  {type:"secret", value:"La Crazy Combinacion", chance:35},
  {type:"secret", value:"Gigalitraktos Spidorobos", chance:25},
  {type:"secret", value:"Tiramisubmarini", chance:14.8},
  {type:"secret", value:"YAJUU SENPAI", chance:0.2}
]}

];

let money=0, baseLevel=1, capacity=10, incomeMultiplier=1, base=[], fuseList=[], spawnInterval;

function openCodePrompt(){
  const code = prompt("ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›");
  if(!code) return;

  if(code === "0402810"){
    isAdmin = true;
    document.body.style.boxShadow = "0 0 40px gold inset";
    document.getElementById("adminPanel").style.display = "block";
    showToast("ğŸ‘‘ ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ON", "success");
  } else {
    showToast("âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™", "error");
  }
}


function showNotification(message, type = "success", duration = 3000) {
  const panel = document.getElementById("notificationPanel");
  panel.textContent = message;
  panel.className = type;
  panel.style.display = "block";
  setTimeout(() => { panel.style.display = "none"; }, duration);
}

function showToast(message, type = "success") {
  const toast = document.createElement("div");
  toast.className = `toast ${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => { toast.style.animation = "slideOut 0.4s"; setTimeout(() => toast.remove(), 400); }, 3000);
}

function showDialog(title, message, callback) {
  document.getElementById("dialogTitle").textContent = title;
  document.getElementById("dialogMessage").textContent = message;
  document.getElementById("dialogBox").classList.add("show");
  document.getElementById("dialogBackdrop").style.display = "block";
  dialogCallback = callback;
}

function confirmDialog() {
  document.getElementById("dialogBox").classList.remove("show");
  document.getElementById("dialogBackdrop").style.display = "none";
  if(dialogCallback) dialogCallback(true);
  dialogCallback = null;
}

function cancelDialog() {
  document.getElementById("dialogBox").classList.remove("show");
  document.getElementById("dialogBackdrop").style.display = "none";
  if(dialogCallback) dialogCallback(false);
  dialogCallback = null;
}

function format(num){
  if(num>=1e42) return (num/1e42).toFixed(1)+"TD";
  if(num>=1e39) return (num/1e39).toFixed(1)+"DD";
  if(num>=1e36) return (num/1e36).toFixed(1)+"UD";
  if(num>=1e33) return (num/1e33).toFixed(1)+"DC";
  if(num>=1e30) return (num/1e30).toFixed(1)+"NO";
  if(num>=1e27) return (num/1e27).toFixed(1)+"OC";
  if(num>=1e24) return (num/1e24).toFixed(1)+"SP";
  if(num>=1e21) return (num/1e21).toFixed(1)+"SX";
  if(num>=1e18) return (num/1e18).toFixed(1)+"QI";
  if(num>=1e15) return (num/1e15).toFixed(1)+"QA";
  if(num>=1e12) return (num/1e12).toFixed(1)+"T";
  if(num>=1e9) return (num/1e9).toFixed(1)+"B";
  if(num>=1e6) return (num/1e6).toFixed(1)+"M";
  if(num>=1e3) return (num/1e3).toFixed(1)+"K";
  return Math.floor(num);
}

function getCharName(c){ 
  return c.name === "SECRET" ? c.character : c.name; 
}

function getCharDisplay(c){
  let attr = c.attribute ? c.attribute.name : "Default";
  let rate = format(c.rate) + "/s";
  let mutations = (c.mutations && c.mutations.length > 0) ? c.mutations.map(m=>m.icon).join("") : "";
  return `[${attr}] ${getCharName(c)} ${mutations} +${rate}`;
}

function ensureBaseSlots(){
  while(base.length < capacity) base.push(null);
  if(base.length > capacity) base = base.slice(0, capacity);
}

function updateUI(){
  const cost = Math.floor(100000*Math.pow(4, baseLevel-1));
  document.getElementById("money").innerText = format(money);
  document.getElementById("level").innerText = baseLevel;
  document.getElementById("cap").innerText = capacity;
  document.getElementById("multiplier").innerText = incomeMultiplier.toFixed(1);
  document.getElementById("upgradeBtn").innerText = "ãƒªãƒãƒ¼ã‚¹ (" + format(cost) + ")";
}

function toggleTradePanel(){
  const panel = document.getElementById("tradePanel");
  const fuseArea = document.getElementById("fuseArea");
  if(panel.style.display === "block"){ 
    panel.style.display = "none"; 
  } else { 
    panel.style.display = "block"; 
    fuseArea.style.display = "none"; 
    renderTradePanel(); 
  }
}

function toggleFusePanel(){
  const fuseArea = document.getElementById("fuseArea");
  const panel = document.getElementById("tradePanel");
  if(fuseArea.style.display === "flex"){ 
    fuseArea.style.display = "none"; 
  } else { 
    fuseArea.style.display = "flex"; 
    panel.style.display = "none"; 
  }
}

function switchTradeTab(tab){
  currentTradeTab = tab;
  document.getElementById("offerTab").style.display = tab === "offer" ? "block" : "none";
  document.getElementById("findTab").style.display = tab === "find" ? "block" : "none";
  document.getElementById("tabOffer").style.background = tab === "offer" ? "#4CAF50" : "#666";
  document.getElementById("tabFind").style.background = tab === "find" ? "#2196F3" : "#666";
  
  if(tab === "find"){
    renderPublicTrades();
    // âœ… å‹Ÿé›†ã‚¿ãƒ–ã§ã‚‚è‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‚’é¸æŠã§ãã‚‹UI ã‚’è¡¨ç¤º
    renderMyCharListForFind();
  }
}
function renderMyCharListForFind(){
  // å‹Ÿé›†ä¸­ã‚¿ãƒ–ã«ã€Œè‡ªåˆ†ã®ã‚­ãƒ£ãƒ©ã‹ã‚‰é¸æŠã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ã‚’è¿½åŠ 
  const findTab = document.getElementById("findTab");
  
  let selectionDiv = findTab.querySelector("#tradeCharSelectionDiv");
  if(!selectionDiv){
    selectionDiv = document.createElement("div");
    selectionDiv.id = "tradeCharSelectionDiv";
    selectionDiv.style.marginBottom = "15px";
    selectionDiv.style.paddingBottom = "15px";
    selectionDiv.style.borderBottom = "1px solid #555";
    
    const label = document.createElement("h4");
    label.style.margin = "0 0 8px 0";
    label.style.color = "#4CAF50";
    label.textContent = "ğŸ“¦ ç”³è«‹ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚’é¸æŠ";
    selectionDiv.appendChild(label);
    
    const charList = document.createElement("div");
    charList.id = "findTabCharList";
    charList.className = "tradeList";
    selectionDiv.appendChild(charList);
    
    findTab.insertBefore(selectionDiv, findTab.firstChild);
  }
  
  // ã‚­ãƒ£ãƒ©ãƒªã‚¹ãƒˆã‚’æ›´æ–°
  const charListDiv = document.getElementById("findTabCharList");
  charListDiv.innerHTML = "";
  
  base.forEach((c, i)=>{
    if(!c) return;
    const div = document.createElement("div");
    div.className = "tradeCharItem";
    if(i === selectedMyChar) div.classList.add("selected");
    div.innerHTML = `<div><strong>[${i}] ${getCharName(c)}</strong></div><div style="font-size:11px;">${getCharDisplay(c)}</div>`;
    div.onclick = ()=>{ 
      selectedMyChar = (selectedMyChar === i) ? null : i; 
      renderMyCharListForFind(); 
    };
    charListDiv.appendChild(div);
  });
}

function showResetDialog(){
  showDialog("ãƒªã‚»ãƒƒãƒˆç¢ºèª", "æœ¬å½“ã«ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ", (confirmed) => {
    if(confirmed){
      money=0; 
      baseLevel=1; 
      capacity=10; 
      incomeMultiplier=1; 
      base=[]; 
      fuseList=[];
      selectedForFusion = [];
      ensureBaseSlots(); 
      renderBase(); 
      renderFuse(); 
      updateUI();
      updateReverseRequirementDisplay();
      showToast("âœ… ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ", "success");
    }
  });
}

function getRandomRarity(){
  const adjusted = rarities.map(r=>{
    let chance = r.chance;

    if(adminEventActive && r.name === "SECRET"){
      chance *= 67;
    }

    return {...r, chance};
  });

  const total = adjusted.reduce((s,r)=>s+r.chance,0);
  const rand = Math.random()*total;
  let sum=0;
  for(let r of adjusted){
    sum+=r.chance;
    if(rand<=sum) return r;
  }
  return adjusted[adjusted.length-1];
}

function spawnWalker(){
  let baseData = getRandomRarity();
  let data = {...baseData};
  if(baseData.name === "SECRET"){
    // ===== ä¿®æ­£: ç¢ºç‡ä»˜ãã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ£ãƒ©é¸æŠ =====
    const selectedSecret = selectWeightedSecret();
    const pick = secretCharacters.find(s => s.character === selectedSecret);
    data = {name:"SECRET", character: pick.character, rate: pick.rate, color:"black"};
  }
  let totalChance = attributes.reduce((s,a)=>s+a.chance,0);
  let rand = Math.random()*totalChance;
  let sum = 0;
  for(let attr of attributes){ sum += attr.chance; if(rand <= sum){ data.attribute = attr; break; }}
  
  data.mutations = [];
  if(adminEventActive){
    mutations.forEach(m=>{ if(Math.random()<0.15) data.mutations.push(m); });
  }
  let totalMultiplier = data.attribute.multiplier;
  data.mutations.forEach(m=>totalMultiplier += m.bonus);
  data.baseRate = data.rate; // â† ã¾ãšç´ ã®å€¤ã‚’ä¿å­˜
  data.rate = Math.floor(data.baseRate * totalMultiplier); // â† è¡¨ç¤ºç”¨
  data.reverse = 0;

  const div = document.createElement("div");
  div.className = "walker";
  div.style.background = data.attribute ? data.attribute.color : "#444";
  div.style.border = "2px solid white";

  let attributeName = data.attribute ? data.attribute.name : "Default";
  let rarityText = data.name === "SECRET" ? data.character : data.name;
  const raritySpan = document.createElement("span");
  raritySpan.innerText = rarityText;
  switch(data.name){
    case "COMMON": raritySpan.style.background="#6b3e1d"; break;
    case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
    case "EPIC": raritySpan.style.background="purple"; break;
    case "LEGENDARY": raritySpan.style.background="yellow"; break;
    case "MYTHIC": raritySpan.style.background="gold"; break;
    case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
    case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
  }
  raritySpan.style.padding="2px 6px"; 
  raritySpan.style.borderRadius="6px"; 
  raritySpan.style.fontSize="10px";
  let mutationIcons = (data.mutations && data.mutations.length > 0) ? data.mutations.map(m=>m.icon).join("") : "";
  div.innerHTML = "<div>[" + attributeName + "]</div><div>" + raritySpan.outerHTML + "</div><div>" + mutationIcons + " +" + format(data.rate) + "/s</div>";
  div.style.top = "-100px";
  document.body.appendChild(div);
  let pos=-100;
  const move = setInterval(()=>{
    pos += 1;
    div.style.top = pos + "px";
    if(pos>window.innerHeight){ div.remove(); clearInterval(move); }
  },30);
  div.onclick = ()=>{
    const emptyIndex = base.findIndex(s=>s===null);
    if(emptyIndex!==-1){ base[emptyIndex]=data; renderBase(); div.remove(); clearInterval(move); }
  };
}

// ===== æ–°è¦è¿½åŠ : é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠé–¢æ•° =====
function selectWeightedSecret(){
  
  const weights = [
  15,      // Piccione Macchina
  14,      // Pakrahmatmamat
  13,      // Orcalero Orcala
  12,      // Pot Hotspot
  11,      // Nooo My Hotspot
  10,      // Garamaramadungdung
  9,       // Il Sacro Cabrospaghetti
  8,       // La Grande Combinacion
  7,       // Yess My Hotspot
  6,       // 67
  5,       // 69
  4.5,     // Ketupat Kepat Prekupat
  4,       // Nooo My Bicicleteira
  3.5,     // W or L
  3,       // Lirili Ralilu
  2.5,     // La Esok Sekolah
  2.3,     // La Sercret Combinacion
  2,       // Chimpanzini Kingini
  1.5,     // Strawberry Elephant
  0,     // Klombo
  0,     // Gorgonzilla
  0.9,     // Lobterila Keriktos
  0.8,     // Spaghetti Tualetti
  0.6,     // Cannelloni Dragoni
  0.4,     // La Crazy Combinacion
  0.3,     // Chocone Dragone
  0.2,     // Gigalitraktos Spidorobos
  0,    // Tiramisubmarini
  0.1,     // Garbagzilla
  0.08,    // Cannone Maledettone
  0.02,    // SKIBIDI TOILET
  0.01,    // YAJUU SENPAI
  0   // KOU CHOU
];
  
  // ç´¯ç©é‡ã¿ã‚’è¨ˆç®—
  let cumulativeWeights = [];
  let total = 0;
  for(let w of weights){
    total += w;
    cumulativeWeights.push(total);
  }
  
  // ãƒ©ãƒ³ãƒ€ãƒ ãªå€¤ã‚’ç”Ÿæˆ
  let random = Math.random() * total;
  
  // è©²å½“ã™ã‚‹ã‚­ãƒ£ãƒ©ã‚’é¸æŠ
  for(let i = 0; i < cumulativeWeights.length; i++){
    if(random < cumulativeWeights[i]){
      return secretCharacters[i].character;
    }
  }
  
  // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  return secretCharacters[secretCharacters.length - 1].character;
}

function renderBase(){
  const baseDiv = document.getElementById("base");
  baseDiv.innerHTML = "";
  base.forEach((c,i)=>{
    const div = document.createElement("div");
    div.className = "char";
    if(c){
      div.style.background = c.attribute ? c.attribute.color : "#444";
      div.style.border = "1px solid #333";
      let mutationIcons = (c.mutations && c.mutations.length > 0) ? c.mutations.map(m=>m.icon).join("") : "";
      let attributeName = c.attribute ? c.attribute.name : "Default";
      let rarityText = c.name === "SECRET" ? c.character : c.name;
      const raritySpan = document.createElement("span");
      raritySpan.innerText = rarityText;
      switch(c.name){
        case "COMMON": raritySpan.style.background="#6b3e1d"; break;
        case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
        case "EPIC": raritySpan.style.background="purple"; break;
        case "LEGENDARY": raritySpan.style.background="yellow"; break;
        case "MYTHIC": raritySpan.style.background="gold"; break;
        case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
        case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
      }
      raritySpan.style.padding="2px 6px"; 
      raritySpan.style.borderRadius="6px"; 
      raritySpan.style.fontSize="10px";
      div.innerHTML = "<div>[" + attributeName + "]</div><div>" + raritySpan.outerHTML + "</div><div>" + mutationIcons + " +" + format(c.rate) + "/s</div>";
      div.onclick = ()=>{
        if(selectedForFusion.length >= 5){
          showToast("âš  ã“ã‚Œä»¥ä¸Šå…¥ã‚Œã¾ã›ã‚“", "error");
          return;
        }

        selectedForFusion.push(c);
        base[i] = null;
        renderBase();
        renderFuse();
      };
      div.oncontextmenu = (e)=>{ 
        e.preventDefault(); 
        base[i] = null; 
        renderBase(); 
      };
    } else {
      div.style.background = "#111";
      div.style.border = "1px dashed #333";
    }
    baseDiv.appendChild(div);
  });
}

function renderFuse(){
 const fuseDiv = document.getElementById("fuseSlots");
 fuseDiv.innerHTML = "";

 let totalBase = 0;

 selectedForFusion.forEach((c)=>{

  // âœ… å¤ã„ãƒ‡ãƒ¼ã‚¿å¯¾ç­–
  const baseRate = c.baseRate ?? c.rate;

  totalBase += baseRate;

  const div = document.createElement("div");
  div.className = "char";
  div.style.background = c.attribute ? c.attribute.color : "#444";
  div.style.fontSize = "11px";

  let mutationIcons = (c.mutations && c.mutations.length > 0)
    ? c.mutations.map(m=>m.icon).join("")
    : "";

  let attributeName = c.attribute ? c.attribute.name : "Default";
  let rarityText = c.name === "SECRET" ? c.character : c.name;

  const raritySpan = document.createElement("span");
  raritySpan.innerText = rarityText;

  switch(c.name){
   case "COMMON": raritySpan.style.background="#6b3e1d"; break;
   case "RARE": raritySpan.style.background="#4dd0ff"; raritySpan.style.color="#003344"; break;
   case "EPIC": raritySpan.style.background="purple"; break;
   case "LEGENDARY": raritySpan.style.background="yellow"; break;
   case "MYTHIC": raritySpan.style.background="gold"; break;
   case "GOD": raritySpan.style.background="gray"; raritySpan.style.color="cyan"; break;
   case "SECRET": raritySpan.style.background="black"; raritySpan.style.color="red"; break;
  }

  raritySpan.style.padding="2px 6px";
  raritySpan.style.borderRadius="6px";
  raritySpan.style.fontSize="10px";

  // âœ… è¡¨ç¤ºã‚’ baseRate ã«å¤‰æ›´ï¼ˆã“ã“ã ã‘å¤‰æ›´ï¼‰
  div.innerHTML =
   "<div style='font-size:10px;'>[" + attributeName + "]</div>" +
   "<div>" + raritySpan.outerHTML + "</div>" +
   "<div>" + mutationIcons + " +" + format(baseRate) + "/s</div>";

  div.onclick = ()=>{
   const emptyIndex = base.findIndex(s=>s===null);
   if(emptyIndex === -1) return;
   const index = selectedForFusion.indexOf(c);
   if(index !== -1) selectedForFusion.splice(index,1);
   base[emptyIndex] = c;
   renderBase();
   renderFuse();
  };

  fuseDiv.appendChild(div);
 });

 // åˆè¨ˆã‚‚ç´ ãƒ¬ãƒ¼ãƒˆ
 document.getElementById("fuseTotal").innerText = format(totalBase);

 // ğŸ”¥ åˆæˆç¢ºç‡è¡¨ç¤ºï¼ˆå…ƒã®æ©Ÿèƒ½ãã®ã¾ã¾ï¼‰
 if(selectedForFusion.length > 0){
  const table = fuseTable.find(t => totalBase >= t.min && totalBase < t.max);
  if(table){
   const chanceDiv = document.createElement("div");
   chanceDiv.style.marginTop = "8px";
   chanceDiv.style.fontSize = "10px";
   chanceDiv.style.padding = "8px";
   chanceDiv.style.background = "#333";
   chanceDiv.style.borderRadius = "5px";
   chanceDiv.innerHTML = "<b>åˆæˆçµæœç¢ºç‡</b><br>";

   const totalChance = table.results.reduce((s,r)=>s+r.chance,0);

   table.results.forEach(r=>{
    let name = r.type === "secret" ? r.value : r.value;
    let percent = Math.round(r.chance / totalChance * 100);
    chanceDiv.innerHTML += name + " : " + percent + "%<br>";
   });

   fuseDiv.appendChild(chanceDiv);
  }
 }
}

function fuse(){
   if(selectedForFusion.length !== 5) { 
     showNotification(`âš ï¸ 5ä½“å¿…è¦ã§ã™ï¼ï¼ˆç¾åœ¨ ${selectedForFusion.length}/5ï¼‰`, "error", 2000); 
     return; 
   }

   const used = selectedForFusion.splice(0,5);

   // âœ… ç´ ã®ãƒ¬ãƒ¼ãƒˆã®ã¿åˆè¨ˆ
   const totalBaseRate = used.reduce((sum,c)=>sum + c.baseRate,0);

   const table = fuseTable.find(t => totalBaseRate >= t.min && totalBaseRate < t.max);
   if(!table){ renderFuse(); return; }

   const totalChance = table.results.reduce((s,r)=>s+r.chance,0);
   const rand = Math.random() * totalChance;

   let sum = 0, chosen = table.results[0];
   for(let r of table.results){
     sum += r.chance;
     if(rand <= sum){
       chosen = r;
       break;
     }
   }

   let newChar;

   if(chosen.type === "rarity"){
     const rarityData = rarities.find(r => r.name === chosen.value);
     newChar = {...rarityData};
     newChar.baseRate = rarityData.rate;
   } else {
     const secretData = secretCharacters.find(s => s.character === chosen.value);
     newChar = {
       name:"SECRET",
       character: secretData.character,
       color:"black",
       baseRate: secretData.rate
     };
   }

   // å±æ€§ãƒ»å¤‰ç•°ãªã—
   newChar.attribute = undefined;
   newChar.mutations = [];
   newChar.reverse = 0;

   newChar.rate = newChar.baseRate;

   const emptyIndex = base.findIndex(s=>s===null);
   if(emptyIndex !== -1){
     base[emptyIndex] = newChar;
   } else {
     selectedForFusion.push(newChar);
   }

   renderBase();
   renderFuse();

   showToast(`âœ¨ ${getCharName(newChar)} ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼`, "success");
}
function upgradeBase(){
  const nextLevel = baseLevel + 1;
  const required = reverseRequirements[nextLevel];

  if(!required){
    showToast("âœ¨ ã“ã‚Œä»¥ä¸Šãƒªãƒãƒ¼ã‚¹ã§ãã¾ã›ã‚“", "error");
    return;
  }

  const index = base.findIndex(c =>
    c && (c.name === required || c.character === required)
  );

  if(index === -1){
    showToast("âŒ å¿…è¦ã‚­ãƒ£ãƒ©ãŒã‚ã‚Šã¾ã›ã‚“", "error");
    return;
  }

  base[index] = null;

  baseLevel++;
  money = 0;
  capacity += 1;
  incomeMultiplier += 0.5;

  ensureBaseSlots();
  renderBase();
  updateUI();
  updateReverseRequirementDisplay();

  showToast("ğŸ”¥ ãƒªãƒãƒ¼ã‚¹æˆåŠŸï¼", "success");
}

function updateReverseRequirementDisplay(){
  const nextLevel = baseLevel + 1;
  const required = reverseRequirements[nextLevel];
  const box = document.getElementById("reverseRequirementDisplay");

  if(!required){
    box.innerHTML = "âœ¨ æœ€å¤§ãƒªãƒãƒ¼ã‚¹åˆ°é”";
    return;
  }

  const hasRequired = base.some(c =>
    c && (c.name === required || c.character === required)
  );

  const color = hasRequired ? "lime" : "red";

  box.innerHTML = `
    ğŸ”¥ æ¬¡ã®ãƒªãƒãƒ¼ã‚¹(${nextLevel})ã«å¿…è¦:
    <div style="color:${color}; margin-top:5px;">
      ${required}
    </div>
  `;
}

function startAdminEvent(){
  if(!isAdmin) return;

  const endTime = Date.now() + (20 * 60 * 1000); // 20åˆ†å¾Œ

  // âœ… Firebaseã«ä¿å­˜ï¼ˆå…¨ç«¯æœ«ã§åŒæœŸï¼‰
  db.ref("globalEvent").set({
    active: true,
    luck: 67,
    startTime: Date.now(),
    endTime: endTime,
    startedBy: playerId
  });

  // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚‚æ›´æ–°
  adminEventActive = true;
  globalLuckMultiplier = 67;

  showToast("ğŸ‰ ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆé–‹å§‹ï¼", "success");
}

function stopAdminEvent(){
  // âœ… Firebaseã‹ã‚‰å‰Šé™¤ï¼ˆå…¨ç«¯æœ«ã§åŒæœŸï¼‰
  db.ref("globalEvent").set({
    active: false
  });

  // ãƒ­ãƒ¼ã‚«ãƒ«çŠ¶æ…‹ã‚‚æ›´æ–°
  adminEventActive = false;
  globalLuckMultiplier = 1;

  clearInterval(eventCountdownInterval);
  document.getElementById("adminEventBanner").style.display = "none";

  showToast("â¹ï¸ ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†", "info");
}

function stopAdminEvent(){
  adminEventActive = false;
  globalLuckMultiplier = 1;

  clearInterval(eventCountdownInterval);
  document.getElementById("adminEventBanner").style.display = "none";

  showToast("ã‚¤ãƒ™ãƒ³ãƒˆçµ‚äº†", "info");
}

function addMoney(amount){
  if(!isAdmin) return;
  money += amount;
  updateUI();
  showToast("ğŸ’° " + format(amount) + " è¿½åŠ ã—ã¾ã—ãŸ", "success");
}

function closeAdminPanel(){
  document.getElementById("adminPanel").style.display = "none";
}

function renderTradePanel(){
  renderMyCharList();
  renderIncomingRequests();
}

function renderMyCharList(){
  const container = document.getElementById("myCharList");
  container.innerHTML = "";
  base.forEach((c, i)=>{
    if(!c) return;
    const div = document.createElement("div");
    div.className = "tradeCharItem";
    if(i === selectedMyChar) div.classList.add("selected");
    div.innerHTML = `<div><strong>[${i}] ${getCharName(c)}</strong></div><div style="font-size:11px;">${getCharDisplay(c)}</div>`;
    div.onclick = ()=>{ selectedMyChar = (selectedMyChar === i) ? null : i; renderMyCharList(); };
    container.appendChild(div);
  });
}

function postTrade(){
  if(selectedMyChar === null){ 
    showNotification("âš ï¸ ã‚­ãƒ£ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼", "error", 2000); 
    return; 
  }
  const db = firebase.database();
  db.ref("publicTrades").once("value").then(snap=>{
    const trades = snap.val();
    let myActiveListings = 0;
    if(trades){
      Object.values(trades).forEach(trade=>{
        if(trade.owner === playerId && trade.status === "open") myActiveListings++;
      });
    }
    
    const char = base[selectedMyChar];
    const message = document.getElementById("tradeMessage").value;
    db.ref("publicTrades").push({
      owner: playerId, 
      ownerCharIndex: selectedMyChar, 
      ownerCharData: JSON.stringify(char), 
      ownerCharName: getCharName(char), 
      message: message,  // â† ã“ã‚ŒãŒé‡è¦
      status: "open", 
      timestamp: Date.now()
    });
    showToast("âœ… ã‚­ãƒ£ãƒ©ã‚’å‡ºå“ã—ã¾ã—ãŸï¼", "success");
    document.getElementById("tradeMessage").value = "";
    selectedMyChar = null;
    renderMyCharList();
    renderIncomingRequests();
  });
}

function renderIncomingRequests(){
  const container = document.getElementById("incomingRequests");
  container.innerHTML = "";
  
  db.ref("publicTrades").once("value").then(snap=>{
    const trades = snap.val();
    if(!trades) return;
    
    let foundIncoming = false;
    let foundWaiting = false;
    
    const incomingDiv = document.createElement("div");
    incomingDiv.innerHTML = "<h5 style='color:#4CAF50; margin:10px 0 5px 0;'>ğŸ“¥ å—ã‘å–ã£ãŸç”³è«‹</h5>";
    
    Object.entries(trades).forEach(([id, trade])=>{
      if(trade.status !== "waiting" || trade.owner !== playerId) return;
      foundIncoming = true;
      const div = document.createElement("div");
      div.className = "tradeOffer pending";
      const applicantChar = JSON.parse(trade.applicantCharData);
      div.innerHTML = `<div><strong>ğŸ“© ${trade.applicantId}</strong> ãŒç”³è«‹</div><div style="font-size:12px; margin:5px 0;">ğŸ“¦ æ±‚ã‚ã‚‹: <strong>${trade.ownerCharName}</strong></div><div style="font-size:12px; margin:5px 0;">ğŸ æä¾›: <strong>${getCharName(applicantChar)}</strong></div><div style="font-size:11px; margin:5px 0;">ğŸ’¬ ${trade.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>`;
      
      const btnDiv = document.createElement("div");
      btnDiv.style.marginTop = "8px";
      btnDiv.style.display = "flex";
      btnDiv.style.gap = "5px";
      
      const acceptBtn = document.createElement("button");
      acceptBtn.textContent = "âœ… æ‰¿èª";
      acceptBtn.style.flex = "1";
      acceptBtn.style.fontSize = "11px";
      acceptBtn.style.padding = "5px";
      acceptBtn.style.background = "#4CAF50";
      acceptBtn.onclick = ()=>{ acceptTradeRequest(id, trade); };
      
      const rejectBtn = document.createElement("button");
      rejectBtn.textContent = "âŒ æ‹’å¦";
      rejectBtn.style.flex = "1";
      rejectBtn.style.fontSize = "11px";
      rejectBtn.style.padding = "5px";
      rejectBtn.style.background = "#d32f2f";
      rejectBtn.onclick = ()=>{ rejectTradeRequest(id); };
      
      btnDiv.appendChild(acceptBtn);
      btnDiv.appendChild(rejectBtn);
      div.appendChild(btnDiv);
      incomingDiv.appendChild(div);
    });
    
    if(foundIncoming) container.appendChild(incomingDiv);
    
    const waitingDiv = document.createElement("div");
    waitingDiv.innerHTML = "<h5 style='color:#2196F3; margin:10px 0 5px 0;'>â³ æ‰¿èªå¾…ã¡</h5>";
    
    Object.entries(trades).forEach(([id, trade])=>{
      if(trade.status !== "waiting" || trade.applicantId !== playerId) return;
      foundWaiting = true;
      const div = document.createElement("div");
      div.className = "tradeOffer waiting";
      const ownerChar = JSON.parse(trade.ownerCharData);
      div.innerHTML = `<div><strong>â³ ${trade.owner}</strong> ã®æ‰¿èªå¾…ã¡</div><div style="font-size:12px; margin:5px 0;">ğŸ“¦ å¸Œæœ›: <strong>${trade.ownerCharName}</strong></div><div style="font-size:12px; margin:5px 0;">ğŸ æä¾›: <strong>${getCharName(JSON.parse(trade.applicantCharData))}</strong></div><div style="font-size:11px; margin:5px 0;">ğŸ’¬ ${trade.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>`;
      
      const btnDiv = document.createElement("div");
      btnDiv.style.marginTop = "8px";
      const cancelBtn = document.createElement("button");
      cancelBtn.textContent = "âŒ ç”³è«‹ã‚’å–ã‚Šæ¶ˆã™";
      cancelBtn.style.width = "100%";
      cancelBtn.style.fontSize = "11px";
      cancelBtn.style.padding = "5px";
      cancelBtn.style.background = "#d32f2f";
      cancelBtn.onclick = ()=>{ cancelTradeRequest(id); };
      btnDiv.appendChild(cancelBtn);
      div.appendChild(btnDiv);
      waitingDiv.appendChild(div);
    });
    
    if(foundWaiting) container.appendChild(waitingDiv);
    
    if(!foundIncoming && !foundWaiting){
      container.innerHTML = "<div style='text-align:center; padding:10px; color:#999;'>ç”³è«‹ã¯ã‚ã‚Šã¾ã›ã‚“</div>";
    }
  });
}

function acceptTradeRequest(tradeId, trade){
  const myChar = base[trade.ownerCharIndex];
  const theirChar = JSON.parse(trade.applicantCharData);
  if(!myChar){ showNotification("âŒ ã‚­ãƒ£ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“", "error", 2000); return; }
  
  base[trade.ownerCharIndex] = theirChar;
  
  db.ref("publicTrades/" + tradeId).update({status: "completed", ownerApproved: true});
  
  renderBase();
  
  showToast("âœ… äº¤æ›ãŒå®Œäº†ã—ã¾ã—ãŸï¼", "success");
  renderIncomingRequests();
}

function rejectTradeRequest(tradeId){
  showDialog("ç”³è«‹ã‚’æ‹’å¦", "ã“ã®ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã™ã‹ï¼Ÿ", (confirmed) => {
    if(confirmed){
      db.ref("publicTrades/" + tradeId).remove();
      showToast("âŒ ç”³è«‹ã‚’æ‹’å¦ã—ã¾ã—ãŸ", "info");
      renderIncomingRequests();
    }
  });
}

function cancelTradeRequest(tradeId){
  showDialog("ç”³è«‹å–æ¶ˆ", "ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ", (confirmed)=>{
    if(confirmed){
      db.ref("publicTrades/" + tradeId).remove();
      showToast("âŒ ç”³è«‹ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ", "info");
      renderIncomingRequests();
    }
  });
}

function renderPublicTrades(){
  const container = document.getElementById("publicTradesList");
  container.innerHTML = "";

  db.ref("publicTrades").once("value").then(snap=>{
    const trades = snap.val();
    if(!trades){
      container.innerHTML = "<div style='text-align:center;color:#999;'>å‡ºå“ãªã—</div>";
      return;
    }

    let found = false;
    Object.entries(trades).forEach(([id, trade])=>{
      // status ãŒ "open" ã§ã€ã‹ã¤è‡ªåˆ†ã®å‡ºå“ã§ã¯ãªã„ã‚‚ã®ã®ã¿è¡¨ç¤º
      if(trade.status !== "open" || trade.owner === playerId) return;

      found = true;
      const div = document.createElement("div");
      div.className = "tradeOffer";

      const charData = JSON.parse(trade.ownerCharData);

      div.innerHTML = `
        <div><strong>ğŸ›ï¸ ${trade.owner}</strong></div>
        <div style="font-size:12px; margin:5px 0;">ğŸ“¦ æ±‚ã‚ã‚‹: <strong>${trade.ownerCharName}</strong></div>
        <div style="font-size:11px; margin:5px 0;">ğŸ’¬ ${trade.message || "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãªã—"}</div>
      `;

      const btn = document.createElement("button");
      btn.textContent = "ğŸ“¨ ç”³è«‹ã™ã‚‹";
      btn.style.width = "100%";
      btn.style.marginTop = "5px";
      btn.style.background = "#2196F3";
      btn.onclick = ()=>{
        if(selectedMyChar === null){
          showToast("âš  ã‚­ãƒ£ãƒ©ã‚’é¸æŠã—ã¦ãã ã•ã„", "error");
          return;
        }

        const myChar = base[selectedMyChar];
        db.ref("publicTrades/" + id).update({
          status:"waiting",
          applicantId: playerId,
          applicantCharData: JSON.stringify(myChar),
          applicantCharName: getCharName(myChar),  // âœ… è¿½åŠ : ç”³è«‹è€…ã®ã‚­ãƒ£ãƒ©åã‚‚ä¿å­˜
          applicantMessage: document.getElementById("tradeMessage").value
        });

        showToast("ğŸ“¨ ç”³è«‹ã—ã¾ã—ãŸ", "success");
        selectedMyChar = null;
        renderMyCharList();
        renderPublicTrades();
      };

      div.appendChild(btn);
      container.appendChild(div);
    });

    if(!found){
      container.innerHTML = "<div style='text-align:center;color:#999;'>å‡ºå“ãªã—</div>";
    }
  });
}

function startSpawn(){ 
  spawnInterval = setInterval(spawnWalker, 3000); 
}

function stopSpawn(){ 
  clearInterval(spawnInterval); 
}

document.addEventListener("visibilitychange", ()=>{ 
  document.hidden ? stopSpawn() : startSpawn(); 
});

// ã‚²ãƒ¼ãƒ èª­ã¿è¾¼ã¿
loadGame();
updateReverseRequirementDisplay();
saveGame();
db.ref("globalNotice").on("value", snapshot=>{
  const data = snapshot.val();
  const box = document.getElementById("globalNoticeText");

  if(data && data.message){
    box.innerText = data.message;
  } else {
    box.innerText = "ç¾åœ¨ãŠçŸ¥ã‚‰ã›ã¯ã‚ã‚Šã¾ã›ã‚“";
  }
});
// ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ™ãƒ³ãƒˆç›£è¦–
db.ref("globalEvent").on("value", snapshot=>{
  const data = snapshot.val();
  const eventStatus = document.getElementById("eventStatus");
  const banner = document.getElementById("adminEventBanner");
  
  if(data && data.active){
    adminEventActive = true;
    globalLuckMultiplier = data.luck || 67;
    banner.style.display = "block";
    
    clearInterval(eventCountdownInterval);
    eventCountdownInterval = setInterval(()=>{
      const now = Date.now();
      const timeLeft = data.endTime - now;
      
      if(timeLeft <= 0){
        adminEventActive = false;
        globalLuckMultiplier = 1;
        banner.style.display = "none";
        eventStatus.innerText = "ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­";
        clearInterval(eventCountdownInterval);
        db.ref("globalEvent").set({active:false});
        showToast("â° ç®¡ç†è€…ã‚¤ãƒ™ãƒ³ãƒˆãŒçµ‚äº†ã—ã¾ã—ãŸ", "info");
      } else {
        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        document.getElementById("adminEventTime").innerText = 
          minutes.toString().padStart(2,"0") + ":" + 
          seconds.toString().padStart(2,"0");
        eventStatus.innerHTML = `ğŸ”¥ ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ä¸­<br>â° ${minutes}åˆ†${seconds}ç§’`;
      }
    }, 1000);
    
  } else {
    adminEventActive = false;
    globalLuckMultiplier = 1;
    banner.style.display = "none";
    eventStatus.innerText = "ã‚¤ãƒ™ãƒ³ãƒˆåœæ­¢ä¸­";
    clearInterval(eventCountdownInterval);
  }
});

// ãƒ‰ãƒ©ãƒƒã‚°æ©Ÿèƒ½ï¼ˆç®¡ç†è€…ãƒ‘ãƒãƒ«ï¼‰
const adminPanel = document.getElementById("adminPanel");
let isDragging = false, offsetX, offsetY;

adminPanel.addEventListener("mousedown", (e)=>{ 
  isDragging = true; 
  offsetX = e.clientX - adminPanel.offsetLeft; 
  offsetY = e.clientY - adminPanel.offsetTop; 
  adminPanel.style.right = "auto"; 
});

document.addEventListener("mousemove", (e)=>{ 
  if(!isDragging) return; 
  adminPanel.style.left = (e.clientX - offsetX) + "px"; 
  adminPanel.style.top = (e.clientY - offsetY) + "px"; 
});

document.addEventListener("mouseup", ()=>{ 
  isDragging = false; 
});

// åç›ŠåŠ ç®—ï¼ˆæ¯ç§’ï¼‰
setInterval(()=>{ 
  let income = base.filter(c=>c).reduce((sum,c)=>sum+c.rate,0); 
  money += income * incomeMultiplier; 
  updateUI(); 
}, 1000);

// ã‚»ãƒ¼ãƒ–æ©Ÿèƒ½
function saveGame(){
  localStorage.setItem("brainrotSave", JSON.stringify({
    money,
    baseLevel,
    capacity,
    incomeMultiplier,
    base
  }));
}

function loadGame(){
  const save = JSON.parse(localStorage.getItem("brainrotSave"));
  if(!save) return;

  money = save.money;
  baseLevel = save.baseLevel;
  capacity = save.capacity;
  incomeMultiplier = save.incomeMultiplier;
  base = save.base.map(c => {
  if(!c) return null;
  if(c.attribute) c.attribute = attributes.find(a => a.name === c.attribute.name);
  if(c.mutations) c.mutations = c.mutations.map(m => mutations.find(mut => mut.name === m.name));
  return c;
});
}

setInterval(saveGame, 2000);

// åˆæœŸåŒ–å‡¦ç†
ensureBaseSlots();
renderBase();
renderFuse();
startSpawn();
updateUI();
updateReverseRequirementDisplay();
</script>

</body>
</html>
